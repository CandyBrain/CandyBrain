[
    {
        "id": "e8cc38a9cd1fb99d",
        "type": "tab",
        "label": "KIST_OpenChamber",
        "disabled": false,
        "info": ""
    },
    {
        "id": "2ced808b3820b5c5",
        "type": "tab",
        "label": "OpenChamber V2.6 - Fixed Timers",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "7e65b47e49f97f97",
        "type": "tab",
        "label": "DLI Cal",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "f037c979601d240a",
        "type": "tab",
        "label": "CSV Îã§Ïö¥Î°úÎìú",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "fe5f57faf4c94451",
        "type": "mqtt-broker",
        "name": "Local MQTT",
        "broker": "192.168.4.2",
        "port": 1883,
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": 4,
        "keepalive": 60,
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "4885b8b16d8b583a",
        "type": "mqtt in",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "Telemetry 1-min",
        "topic": "kist/+/+/+/telemetry/minute",
        "qos": "0",
        "datatype": "json",
        "broker": "fe5f57faf4c94451",
        "nl": false,
        "rap": false,
        "rh": 0,
        "inputs": 0,
        "x": 220,
        "y": 100,
        "wires": [
            [
                "e0586380835778f8",
                "e0cfc9384c4d0102"
            ]
        ]
    },
    {
        "id": "e0586380835778f8",
        "type": "function",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "JSON ‚Üí Line Protocol (kocData)",
        "func": "// JSON ‚Üí Line Protocol (kocData & kocControl)\nconst p = (typeof msg.payload === 'string') ? JSON.parse(msg.payload) : (msg.payload || {});\nconst m = /^kist\\/([^/]+)\\/([^/]+)\\/([^/]+)\\/telemetry\\/minute$/.exec(msg.topic || \"\");\nif (!m) { node.log(\"Unexpected topic: \" + msg.topic); return null; }\nconst [_, site_id, chamber_id, collector_id] = m;\n\n// edgeKIST ÌÜ†ÌîΩ Î¨¥Ïãú\nif (collector_id === 'edgeKIST') {\n    node.log(\"Ignoring edgeKIST topic: \" + msg.topic);\n    return null;\n}\n\n// defaults\np.org_id = p.org_id || \"KIST\";\np.site_id = p.site_id || site_id;\np.chamber_id = p.chamber_id || chamber_id;\np.collector_id = p.collector_id || collector_id;\np.fw_version = p.fw_version || \"unknown\";\np.sensors = p.sensors || {};\np.control = p.control || {};\n\n// timestamp Ï≤òÎ¶¨: Ìï≠ÏÉÅ ÌòÑÏû¨ ÏãúÍ∞ÑÏúºÎ°ú Í∞ïÏ†ú ÏÑ§Ï†ï\nnode.log(\"Original timestamp: \" + p.timestamp);\np.timestamp = new Date().toISOString(); // Ïòà: 2025-09-04T20:43:00Z\nnode.log(\"Received payload: \" + JSON.stringify(msg.payload));\nnode.log(\"Processed timestamp: \" + p.timestamp);\n\n// ÌïÑÎìú ÎàÑÎùΩ ÌôïÏù∏\nif (!p.sensors.parRaw) node.log(\"Missing parRaw in payload\");\nif (!p.sensors.tRaw) node.log(\"Missing tRaw in payload\");\nif (!p.sensors.hRaw) node.log(\"Missing hRaw in payload\");\nif (!p.sensors.co2Raw) node.log(\"Missing co2Raw in payload\");\nif (!p.sensors.tBME) node.log(\"Missing tBME in payload\");\nif (!p.sensors.hBME) node.log(\"Missing hBME in payload\");\n\nconst tsMs = Date.parse(p.timestamp);\nconst tsNs = (BigInt(tsMs) * 1000000n).toString();\n\nfunction escTag(v) {\n    return String(v).replace(/[\\s,=]/g, \"\\\\$&\");\n}\nfunction escFieldStr(v) {\n    return String(v).replace(/\"/g, '\\\\\"').replace(/[\\s,]/g, \"\\\\$&\");\n}\n\n// kocData Ï§ÄÎπÑ\nconst light_state = p.control.light_1 || p.control.supplemental_light || \"UNKNOWN\";\nconst tagsData = [\n    `org_id=${escTag(p.org_id)}`,\n    `site_id=${escTag(p.site_id)}`,\n    `chamber_id=${escTag(p.chamber_id)}`,\n    `collector_id=${escTag(p.collector_id)}`,\n    `fw_version=${escTag(p.fw_version)}`,\n    `light_state=${escTag(light_state)}`\n].join(\",\");\n\nfunction fFloat(k, v) {\n    const n = Number(v);\n    return Number.isFinite(n) ? `${k}=${n}` : null;\n}\nconst fieldsData = [\n    fFloat(\"pyrRaw\", p.sensors.pyrRaw),\n    fFloat(\"tRaw\", p.sensors.tRaw),\n    fFloat(\"hRaw\", p.sensors.hRaw),\n    fFloat(\"co2Raw\", p.sensors.co2Raw),\n    fFloat(\"tBME\", p.sensors.tBME),\n    fFloat(\"hBME\", p.sensors.hBME),\n    fFloat(\"light_on\", (light_state === \"ON\") ? 1 : 0)\n].filter(Boolean);\n\n// kocControl Ï§ÄÎπÑ\nlet tagsControl = null;\nlet fieldsControl = null;\nconst c = p.control;\nif (c && Object.keys(c).length > 0) {\n    tagsControl = [\n        `org_id=${escTag(p.org_id)}`,\n        `site_id=${escTag(p.site_id)}`,\n        `chamber_id=${escTag(p.chamber_id)}`,\n        `collector_id=${escTag(p.collector_id)}`,\n        `fw_version=${escTag(p.fw_version)}`,\n        `source=${escTag(c.source || \"edge\")}`,\n        `result=${escTag(c.result || \"OK\")}`,\n        `control_name=${escTag(c.damper_pct !== undefined ? \"damper\" : \"light\")}`\n    ].join(\",\");\n    fieldsControl = [];\n    if (c.light_1 || c.supplemental_light) {\n        const v = c.light_1 || c.supplemental_light;\n        fieldsControl.push(fFloat(\"light_on\", (String(v).toUpperCase() === \"ON\") ? 1 : 0));\n        fieldsControl.push(`light_text=\"${escFieldStr(v)}\"`);\n    }\n    if (Number.isFinite(Number(c.damper_pct))) {\n        fieldsControl.push(fFloat(\"damper_pct\", c.damper_pct));\n    }\n    if (c.reason) fieldsControl.push(`reason=\"${escFieldStr(c.reason)}\"`);\n    if (c.error_code) fieldsControl.push(`error_code=\"${escFieldStr(c.error_code)}\"`);\n    fieldsControl = fieldsControl.filter(Boolean);\n}\n\n// Line Protocol Ï∂úÎ†•\nlet lineProtocol = [];\nif (fieldsData.length > 0) {\n    lineProtocol.push(`kocData,${tagsData} ${fieldsData.join(\",\")} ${tsNs}`);\n}\nif (fieldsControl && fieldsControl.length > 0) {\n    lineProtocol.push(`kocControl,${tagsControl} ${fieldsControl.join(\",\")} ${tsNs}`);\n}\n\nif (lineProtocol.length === 0) {\n    node.log(\"No valid data to write\");\n    return null;\n}\n\n// ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏\nnode.log(\"Line Protocol: \" + lineProtocol.join(\"\\n\"));\nmsg.payload = lineProtocol.join(\"\\n\");\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 100,
        "wires": [
            [
                "8e8c33f0051ad6d2",
                "ec54b7f8413ae174"
            ]
        ]
    },
    {
        "id": "8e8c33f0051ad6d2",
        "type": "http request",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "POST /api/v2/write (KIST/KISTopenChamber/ns)",
        "method": "POST",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "http://influxdb2:8086/api/v2/write?org=KIST&bucket=KISTopenChamber&precision=ns",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "text/plain; charset=utf-8"
            }
        ],
        "x": 960,
        "y": 100,
        "wires": [
            [
                "36184280b71be4e9"
            ]
        ]
    },
    {
        "id": "ec54b7f8413ae174",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "LP preview",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "x": 850,
        "y": 60,
        "wires": []
    },
    {
        "id": "e0cfc9384c4d0102",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "debug 5",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 460,
        "y": 60,
        "wires": []
    },
    {
        "id": "36184280b71be4e9",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "debug 6",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "statusCode",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1250,
        "y": 100,
        "wires": []
    },
    {
        "id": "614798014a8b26cb",
        "type": "http in",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "GET /control",
        "url": "/control",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 210,
        "y": 340,
        "wires": [
            [
                "29e55eedfbb17502"
            ]
        ]
    },
    {
        "id": "29e55eedfbb17502",
        "type": "function",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "Í≤ÄÏ¶ù & LineProtocol ÏÉùÏÑ±",
        "func": "// // \"Í≤ÄÏ¶ù & LineProtocol ÏÉùÏÑ±\" ÎÖ∏Îìú - Node-RED Ìò∏Ìôò Î≤ÑÏ†Ñ\n// const q = (msg.req && msg.req.query) || {};\n// const controlType = String(q.controlType || q.type || '').trim();\n// const sectorID = q.sectorID || '0';\n\n// // chamber_id Ï≤òÎ¶¨\n// let chamber = q.chamber_id || 'chamber_001';\n// if (Array.isArray(chamber)) {\n//     chamber = chamber[0];\n// }\n// chamber = String(chamber).trim();\n\n// node.log(\"=== Ï†úÏñ¥ Î™ÖÎ†π Í≤ÄÏ¶ù ÏãúÏûë ===\");\n// node.log(\"controlType: \" + controlType + \", chamber: \" + chamber);\n// node.log(\"Ï†ÑÏ≤¥ ÏøºÎ¶¨: \" + JSON.stringify(q));\n\n// // ÌóàÏö©Îêú Ï†úÏñ¥ ÌÉÄÏûÖ Í≤ÄÏ¶ù\n// const ALLOWED = ['exhaust_fan', 'air_damper', 'temperature_set', 'led_drive'];\n// if (!ALLOWED.includes(controlType)) {\n//     node.log(\"‚ùå ÏûòÎ™ªÎêú controlType: \" + controlType);\n//     msg.statusCode = 400;\n//     msg.payload = { ok: false, error: 'invalid controlType: ' + controlType };\n//     return [null, msg];\n// }\n\n// // Ï†úÏñ¥ Î™®Îìú ÌôïÏù∏\n// const requestedMode = q.mode || 'manual';\n// const isManualControl = requestedMode === 'manual';\n// const isAutoModeSwitch = requestedMode === 'auto' && !q.onoffValue;\n\n// node.log(\"ÏöîÏ≤≠Îêú Î™®Îìú: \" + requestedMode + \", ÏàòÎèôÏ†úÏñ¥: \" + isManualControl + \", ÏûêÎèôÎ™®ÎìúÏ†ÑÌôò: \" + isAutoModeSwitch);\n\n// // Í≥µÌÜµ ÌÉúÍ∑∏ Íµ¨ÏÑ±\n// const tags = [\n//     'org_id=KIST',\n//     'site_id=site_001',\n//     'collector_id=edgeKIST_001',\n//     'chamber_id=' + chamber,\n//     'control_type=' + controlType,\n//     'sectorID=' + sectorID\n// ].join(',');\n\n// // ÌïÑÎìú Íµ¨ÏÑ± Ìï®Ïàò\n// const F = [];\n// function addStr(name, v) { \n//     if (v != null && v !== '') {\n//         F.push(name + '=\"' + String(v).replace(/\"/g, '\\\\\"') + '\"'); \n//     }\n// }\n// function addFloat(name, v) { \n//     const n = parseFloat(v); \n//     if (Number.isFinite(n)) F.push(name + '=' + n); \n// }\n// function addInt(name, v) { \n//     const n = parseInt(v); \n//     if (Number.isFinite(n)) F.push(name + '=' + n + 'i'); \n// }\n\n// // Ï†úÏñ¥ ÌÉÄÏûÖÎ≥Ñ Ï≤òÎ¶¨\n// if (controlType === 'exhaust_fan') {\n//     node.log(\"Î∞∞Í∏∞Ìå¨ Ï†úÏñ¥ Ï≤òÎ¶¨\");\n    \n//     if (q.mode) addStr('mode', q.mode);\n//     if (q.onoffValue) addStr('onoffValue', q.onoffValue);\n    \n//     // ÏàòÎèô Ï†úÏñ¥ ÏãùÎ≥Ñ\n//     if (isManualControl) {\n//         addStr('control_source', 'manual_ui');\n//         addInt('manual_timestamp', Date.now());\n//     }\n// }\n// else if (controlType === 'air_damper') {\n//     node.log(\"ÏóêÏñ¥ÎåêÌçº Ï†úÏñ¥ Ï≤òÎ¶¨\");\n    \n//     if (q.mode) addStr('mode', q.mode);\n//     if (q.onoffValue) addStr('onoffValue', q.onoffValue);\n    \n//     // Ïò®ÎèÑ Í¥ÄÎ†® ÏÑ§Ï†ïÍ∞í (ÏûêÎèô Î™®ÎìúÏóêÏÑú ÏÇ¨Ïö©)\n//     if (q.tempSetPoint !== undefined) addFloat('tempSetPoint', q.tempSetPoint);\n//     if (q.hysteresis_temp !== undefined) addFloat('hysteresis_temp', q.hysteresis_temp);\n//     if (q.min_on_sec !== undefined) addInt('min_on_sec', q.min_on_sec);\n//     if (q.min_off_sec !== undefined) addInt('min_off_sec', q.min_off_sec);\n    \n//     // Ï†úÏñ¥ ÏÜåÏä§ Íµ¨Î∂Ñ\n//     if (isManualControl) {\n//         addStr('control_source', 'manual_ui');\n//         addInt('manual_timestamp', Date.now());\n//     } else if (isAutoModeSwitch) {\n//         addStr('control_source', 'auto_config');\n//     }\n// }\n// else if (controlType === 'led_drive') {\n//     node.log(\"LED Ï†úÏñ¥ Ï≤òÎ¶¨\");\n    \n//     if (q.mode) addStr('mode', q.mode);\n//     if (q.onoffValue) addStr('onoffValue', q.onoffValue);\n    \n//     // LED ÏûêÎèô Ï†úÏñ¥ ÏÑ§Ï†ïÍ∞í\n//     if (q.lightSetPoint !== undefined) addFloat('lightSetPoint', q.lightSetPoint);\n//     if (q.avg_time !== undefined) addInt('avg_time', q.avg_time);\n//     if (q.hysteresis_wm2 !== undefined) addFloat('hysteresis_wm2', q.hysteresis_wm2);\n//     if (q.min_on_sec !== undefined) addInt('min_on_sec', q.min_on_sec);\n//     if (q.min_off_sec !== undefined) addInt('min_off_sec', q.min_off_sec);\n    \n//     // Ï†úÏñ¥ ÏÜåÏä§ Î™ÖÌôïÌûà Íµ¨Î∂Ñ\n//     if (q.manual_control === 'true' || (isManualControl && q.onoffValue)) {\n//         addStr('control_source', 'manual_ui');\n//         addInt('manual_timestamp', Date.now());\n//         addStr('user_initiated', 'true');\n        \n//         // ÏàòÎèô Ï†úÏñ¥ Ïãú ÏûêÎèô Ï†úÏñ¥ ÎπÑÌôúÏÑ±Ìôî ÌîåÎûòÍ∑∏\n//         if (q.disable_auto_control === 'true') {\n//             addStr('auto_control_disabled', 'true');\n//         }\n        \n//         node.log(\"LED ÏàòÎèô Ï†úÏñ¥ Í∏∞Î°ù: \" + q.onoffValue + \" (ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ: \" + Date.now() + \")\");\n        \n//     } else if (isAutoModeSwitch) {\n//         addStr('control_source', 'auto_config');\n//         addStr('auto_mode_enabled', 'true');\n        \n//         // ÏûêÎèô Î™®Îìú Ï†ÑÌôò Ïãú ÏàòÎèô Ï†úÏñ¥ Í∏∞Î°ù ÏÇ≠Ï†ú ÌëúÏãú\n//         if (q.manual_override_cleared === 'true') {\n//             addStr('manual_override_cleared', 'true');\n//         }\n        \n//         node.log(\"LED ÏûêÎèô Î™®Îìú Ï†ÑÌôò\");\n//     }\n// }\n// else if (controlType === 'temperature_set') {\n//     node.log(\"Ïò®ÎèÑ ÏÑ§Ï†ï Ï≤òÎ¶¨\");\n    \n//     if (q.tempSetPoint !== undefined) addFloat('tempSetPoint', q.tempSetPoint);\n//     if (q.mode) addStr('mode', q.mode);\n//     if (q.onoffValue) addStr('onoffValue', q.onoffValue);\n// }\n\n// // Í≥µÌÜµ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä\n// addStr('request_source', 'web_ui');\n// addInt('request_timestamp', Date.now());\n\n// // ÎîîÎ≤ÑÍπÖ Ï†ïÎ≥¥\n// if (q._nonce) addStr('request_id', q._nonce);\n// if (q.control_reason) addStr('reason', q.control_reason);\n\n// // ÌïÑÎìú Í≤ÄÏ¶ù\n// if (!F.length) {\n//     node.log(\"‚ùå ÌïÑÎìú ÏóÜÏùå\");\n//     msg.statusCode = 400;\n//     msg.payload = { ok: false, error: 'no fields' };\n//     return [null, msg];\n// }\n\n// // Influx Line Protocol ÏÉùÏÑ±\n// msg.payload = 'kocControl,' + tags + ' ' + F.join(',');\n// msg._chamber = chamber;\n// msg._controlType = controlType;\n// msg._isManualControl = isManualControl;\n// msg._isAutoModeSwitch = isAutoModeSwitch;\n\n// node.log(\"‚úÖ Ï†úÏñ¥ Î™ÖÎ†π Í≤ÄÏ¶ù ÏôÑÎ£å\");\n// node.log(\"üì§ Line Protocol: \" + msg.payload);\n\n// return [msg, null];\n\n\n// ÏûÖÎ†• ÌÜµÌï©(GET/POST)\nconst method = (msg.req && msg.req.method) || 'GET';\nconst qraw = method === 'POST' ? (msg.req.body || {}) : ((msg.req && msg.req.query) || {});\nconst q = Object.assign({}, qraw);\n\n// ÌóàÏö© ÌÉÄÏûÖ Í≤ÄÏ¶ù\nconst ALLOWED = ['exhaust_fan', 'air_damper', 'temperature_set', 'led_drive'];\nconst controlType = String(q.controlType || q.type || '').trim();\nif (!ALLOWED.includes(controlType)) {\n  msg.statusCode = 400;\n  msg.payload = { ok: false, error: `invalid controlType: ${controlType}` };\n  return [null, msg];\n}\n\n// chamber_id Ï†ïÍ∑úÌôî/Í≤ÄÏ¶ù\nlet chamber = Array.isArray(q.chamber_id) ? q.chamber_id[0] : (q.chamber_id || 'chamber_001');\nchamber = String(chamber).trim();\nif (!/^chamber_\\d{3}$/.test(chamber)) {\n  msg.statusCode = 400;\n  msg.payload = { ok: false, error: 'invalid chamber_id' };\n  return [null, msg];\n}\n\n// Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Ïú†Ìã∏\nconst escTag = v => String(v).replace(/[\\s,=]/g, '\\\\$&');\nconst addStr   = (k, v, F) => { if (v != null && v !== '') F.push(`${k}=\"${String(v).replace(/\"/g,'\\\\\"')}\"`); };\nconst addFloat = (k, v, F) => { const n = Number(v); if (Number.isFinite(n)) F.push(`${k}=${n}`); };\nconst addInt   = (k, v, F) => { const n = parseInt(v, 10); if (Number.isFinite(n)) F.push(`${k}=${n}i`); };\n\n// ÌÉúÍ∑∏\nconst tags = [\n  'org_id=KIST',\n  'site_id=site_001',\n  'collector_id=edgeKIST_001',\n  `chamber_id=${escTag(chamber)}`,\n  `control_type=${escTag(controlType)}`,\n  `sectorID=${escTag(q.sectorID || '0')}`\n].join(',');\n\n// ÌïÑÎìú Íµ¨ÏÑ±\nconst F = [];\n\n// Í≥µÌÜµ Î©îÌÉÄ\nconst desiredMode = q.mode ? String(q.mode).toLowerCase() : undefined;\nconst desiredOnOff = (q.onoffValue != null && q.onoffValue !== '') ? String(q.onoffValue).toUpperCase() : undefined;\n\n// Î™®Îìú/ÏÉÅÌÉú Í∏∞Î°ù (ÏûêÎèô Î™®ÎìúÏóêÏÑúÎäî ÏùòÎèÑÏπò ÏïäÏùÄ OFF Ï†ÄÏû• Î∞©ÏßÄ)\nif (desiredMode) addStr('mode', desiredMode, F);\nif (desiredMode !== 'auto' && desiredOnOff) addStr('onoffValue', desiredOnOff, F);\n\n// ÌÉÄÏûÖÎ≥Ñ ÏÑ§Ï†ïÍ∞í\nif (controlType === 'air_damper') {\n  if (q.tempSetPoint !== undefined) addFloat('tempSetPoint', q.tempSetPoint, F);\n  if (q.hysteresis_temp !== undefined) addFloat('hysteresis_temp', q.hysteresis_temp, F);\n  if (q.min_on_sec !== undefined) addInt('min_on_sec', q.min_on_sec, F);\n  if (q.min_off_sec !== undefined) addInt('min_off_sec', q.min_off_sec, F);\n}\nif (controlType === 'led_drive') {\n  if (q.lightSetPoint !== undefined) addFloat('lightSetPoint', q.lightSetPoint, F);\n  if (q.avg_time !== undefined) addInt('avg_time', q.avg_time, F);\n  if (q.hysteresis_wm2 !== undefined) addFloat('hysteresis_wm2', q.hysteresis_wm2, F);\n  if (q.min_on_sec !== undefined) addInt('min_on_sec', q.min_on_sec, F);\n  if (q.min_off_sec !== undefined) addInt('min_off_sec', q.min_off_sec, F);\n}\nif (controlType === 'temperature_set') {\n  if (q.tempSetPoint !== undefined) addFloat('tempSetPoint', q.tempSetPoint, F);\n}\n\n// ÏàòÎèô Ïò§Î≤ÑÎùºÏù¥Îìú ÌåêÎã® Î∞è Ï†ÄÏû•\nconst isManualOverride =\n  q.manual_override === 'true' ||\n  q.force_manual === 'true' ||\n  (desiredMode === 'manual' && !!desiredOnOff);\n\nif (isManualOverride) {\n  const ovKey = `manual_override_${chamber}_${controlType}`;\n  const ov = {\n    timestamp: Date.now(),\n    state: desiredOnOff || 'UNKNOWN',\n    mode: 'manual',\n    chamber,\n    controlType\n  };\n  context.set(ovKey, ov);\n  addStr('manual_override', 'true', F);\n  addInt('override_timestamp', ov.timestamp, F);\n}\n\n// UI Ï¶âÏãú Î≥ÄÍ≤Ω ÌõÑ Ïä§ÏºÄÏ§ÑÎü¨ Î≥¥Ìò∏Íµ¨Í∞Ñ(Î†àÏù¥Ïä§ Î∞©ÏßÄ) ÎßàÌÇπ\nconst uiWriteKey = `last_ui_write_${chamber}_${controlType}`;\ncontext.set(uiWriteKey, Date.now());\n\n// Ï†úÏñ¥ ÏÜåÏä§/ÏöîÏ≤≠ Î©îÌÉÄ\nif (desiredMode || desiredOnOff) {\n  const src = isManualOverride ? 'manual_ui' : (desiredMode === 'manual' ? 'manual' : 'auto');\n  addStr('control_source', src, F);\n  addInt('control_timestamp', Date.now(), F);\n  if (q._nonce) addStr('request_id', q._nonce, F);\n}\n\nif (!F.length) {\n  msg.statusCode = 400;\n  msg.payload = { ok: false, error: 'no fields' };\n  return [null, msg];\n}\n\n// Influx Line Protocol\nmsg.payload = `kocControl,${tags} ${F.join(',')}`;\nmsg._chamber = chamber;\nmsg._controlType = controlType;\n\nreturn [msg, null];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 430,
        "y": 340,
        "wires": [
            [
                "0b11070867e85c91",
                "af449073f8bc1dcb",
                "f8f835d564e9c2ca"
            ],
            [
                "78cdc40e9fba583a"
            ]
        ]
    },
    {
        "id": "0b11070867e85c91",
        "type": "http request",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "Influx Write (LP)",
        "method": "POST",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "http://influxdb2:8086/api/v2/write?org=KIST&bucket=KISTopenChamber&precision=ns",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "text/plain; charset=utf-8"
            },
            {
                "keyType": "Accept",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 720,
        "y": 300,
        "wires": [
            [
                "4a207065043b3f66"
            ]
        ]
    },
    {
        "id": "af449073f8bc1dcb",
        "type": "function",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "ÏÑ†ÌÉù: MQTT Î©îÏãúÏßÄ Íµ¨ÏÑ±",
        "func": "// // Node-RED \"ÏÑ†ÌÉù: MQTT Î©îÏãúÏßÄ Íµ¨ÏÑ±\" ÎÖ∏Îìú ÏàòÏ†ï ÏΩîÎìú\n// const q = (msg.req && msg.req.query) || {};\n// const controlType = String(q.controlType || q.type || '').trim();\n\n// // chamber_id Ï≤òÎ¶¨: Î∞∞Ïó¥Ïù¥Î©¥ Ï≤´ Î≤àÏß∏ Í∞íÎßå ÏÇ¨Ïö©\n// let chamber = q.chamber_id || 'chamber_001';\n// if (Array.isArray(chamber)) {\n//     chamber = chamber[0];\n//     node.log(`MQTT Íµ¨ÏÑ±: chamber_id Î∞∞Ïó¥ Í∞êÏßÄ -> ${chamber} ÏÇ¨Ïö©`);\n// }\n// chamber = String(chamber).trim();\n\n// // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏ Ï∂îÍ∞Ä\n// node.log(`=== MQTT Î©îÏãúÏßÄ Íµ¨ÏÑ± ÎîîÎ≤ÑÍπÖ ===`);\n// node.log(`Î∞õÏùÄ controlType: \"${controlType}\"`);\n// node.log(`Î∞õÏùÄ chamber: \"${chamber}\"`);\n// node.log(`Ï†ÑÏ≤¥ ÏøºÎ¶¨: ${JSON.stringify(q)}`);\n\n// const usesOnOff = ['exhaust_fan', 'air_damper', 'led_drive'].includes(controlType);\n// const desiredMode = q.mode || undefined;\n// const desiredOnOff = usesOnOff ? (q.onoffValue || (desiredMode === 'auto' ? 'OFF' : undefined)) : undefined;\n\n// // LED ÏûêÎèô Î™®ÎìúÏùº ÎïåÎßå MQTT Î∞úÌñâ Í∏àÏßÄ\n// if (controlType === 'led_drive' && desiredMode === 'auto') {\n//     node.log(`LED ÏûêÎèô Î™®Îìú: ÏÑ§Ï†ï Ï†ÄÏû•Îßå, Ï¶âÏãú MQTT Î∞úÌñâ ÏïàÌï® (chamber=${chamber})`);\n//     return null;\n// }\n\n// // controlType Í≤ÄÏ¶ù\n// if (!controlType || !['exhaust_fan', 'air_damper', 'led_drive', 'temperature_set'].includes(controlType)) {\n//     node.error(`ÏûòÎ™ªÎêú controlType: \"${controlType}\"`);\n//     return null;\n// }\n\n// const payload = {\n//   type: `control_${controlType}`,\n//   controlType: controlType,  // Î™ÖÏãúÏ†ÅÏúºÎ°ú Ï†ÑÎã¨\n//   mode: desiredMode,\n//   onoffValue: desiredOnOff,\n//   lightSetPoint: q.lightSetPoint ? Number(q.lightSetPoint) : undefined,\n//   avg_time: q.avg_time ? parseInt(q.avg_time) : undefined,\n//   tempSetPoint: q.tempSetPoint ? Number(q.tempSetPoint) : undefined,\n//   chamber_id: chamber,\n//   ts: new Date().toISOString()\n// };\n\n// // ÌÜ†ÌîΩ ÏÉùÏÑ± (controlTypeÎ≥ÑÎ°ú Îã§Î•∏ ÌÜ†ÌîΩ)\n// msg.topic = `kist/control/site_001/${chamber}/edgeKIST_001/${controlType}`;\n// msg.payload = JSON.stringify(payload);\n\n// // ÏÉÅÏÑ∏ Î°úÍ∑∏\n// node.log(`=== MQTT Î∞úÌñâ Ï†ïÎ≥¥ ===`);\n// node.log(`ÏµúÏ¢Ö controlType: \"${controlType}\"`);\n// node.log(`ÏÉùÏÑ±Îêú ÌÜ†ÌîΩ: \"${msg.topic}\"`);\n// node.log(`ÌéòÏù¥Î°úÎìú controlType: \"${payload.controlType}\"`);\n// node.log(`Î™®Îìú: ${desiredMode}, ÏÉÅÌÉú: ${desiredOnOff}`);\n\n// return msg;\n\n\n// Ïò§Îäò Ï£ºÏÑù\n// // Í∏∞Ï°¥ \"ÏÑ†ÌÉù: MQTT Î©îÏãúÏßÄ Íµ¨ÏÑ±\" ÎÖ∏ÎìúÏùò Îã®Ïàú ÏàòÏ†ï Î≤ÑÏ†Ñ\n// // ÏõêÎ≥∏ ÏΩîÎìúÎ•º Í±∞Ïùò Í∑∏ÎåÄÎ°ú Ïú†ÏßÄÌïòÎêò, LED ÏûêÎèô Î™®Îìú Ï≤òÎ¶¨Îßå ÏàòÏ†ï\n\n// const q = (msg.req && msg.req.query) || {};\n// const controlType = String(q.controlType || q.type || '').trim();\n// const sectorID = q.sectorID || '0';\n\n// // chamber_id Ï≤òÎ¶¨: Î∞∞Ïó¥Ïù¥Î©¥ Ï≤´ Î≤àÏß∏ Í∞íÎßå ÏÇ¨Ïö©\n// let chamber = q.chamber_id || 'chamber_001';\n// if (Array.isArray(chamber)) {\n//     chamber = chamber[0];\n//     node.log(`MQTT Íµ¨ÏÑ±: chamber_id Î∞∞Ïó¥ Í∞êÏßÄ -> ${chamber} ÏÇ¨Ïö©`);\n// }\n// chamber = String(chamber).trim();\n\n// // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏\n// node.log(\"=== MQTT Î©îÏãúÏßÄ Íµ¨ÏÑ± ÎîîÎ≤ÑÍπÖ ===\");\n// node.log(`Î∞õÏùÄ controlType: ${controlType}`);\n// node.log(`Î∞õÏùÄ chamber: ${chamber}`);\n// node.log(`Ï†ÑÏ≤¥ ÏøºÎ¶¨: ${JSON.stringify(q)}`);\n\n// const usesOnOff = ['exhaust_fan', 'air_damper', 'led_drive'].includes(controlType);\n// const desiredMode = q.mode || undefined;\n// const desiredOnOff = usesOnOff ? (q.onoffValue || (desiredMode === 'auto' ? 'OFF' : undefined)) : undefined;\n\n// // Ï†úÏñ¥ Í∂åÌïú Ï≤¥ÌÅ¨\n// const isManualControl = (desiredMode === 'manual' && desiredOnOff);\n// const isAutoModeSwitch = (desiredMode === 'auto' && !desiredOnOff);\n\n// node.log(`Î™®Îìú: ${desiredMode}, ÏÉÅÌÉú: ${desiredOnOff}`);\n// node.log(`ÏàòÎèôÏ†úÏñ¥: ${isManualControl}, ÏûêÎèôÎ™®ÎìúÏ†ÑÌôò: ${isAutoModeSwitch}`);\n\n// // ============ ÌïµÏã¨ ÏàòÏ†ï: LED ÏûêÎèô Î™®Îìú Ï≤òÎ¶¨Îßå Î≥ÄÍ≤Ω ============\n// // LED Ï†úÏñ¥ ÌäπÎ≥Ñ Ï≤òÎ¶¨\n// if (controlType === 'led_drive') {\n//     // ÏàòÎèô Ï†úÏñ¥Îäî Ìï≠ÏÉÅ ÌóàÏö©\n//     if (desiredMode === 'manual') {\n//         node.log(`LED ÏàòÎèô Ï†úÏñ¥: Ï¶âÏãú ESP32Î°ú Ï†ÑÏÜ° (${desiredOnOff})`);\n//         // Í≥ÑÏÜç ÏßÑÌñâ ‚Üí MQTT Î∞úÌñâ\n//     }\n//     // ÏûêÎèô Î™®Îìú Ï†ÑÌôòÎßå Ï∞®Îã® (ÏÑ§Ï†ï Ï†ÄÏû•Ïö©)\n//     else if (desiredMode === 'auto' && !desiredOnOff) {\n//         node.log(`LED ÏûêÎèô Î™®Îìú Ï†ÑÌôò: ÏÑ§Ï†ï Ï†ÄÏû•Îßå, Ï†úÏñ¥Îäî Ïä§ÏºÄÏ§ÑÎü¨Ïóê ÏúÑÏûÑ`);\n//         return null;\n//     }\n//     // ÏûêÎèô Ïä§ÏºÄÏ§ÑÎü¨ÏóêÏÑú Ïò§Îäî Ïã§Ï†ú Ï†úÏñ¥ Î™ÖÎ†πÏùÄ ÌóàÏö©\n//     else if (desiredMode === 'auto' && desiredOnOff) {\n//         node.log(`LED ÏûêÎèô Ï†úÏñ¥ Î™ÖÎ†π: ESP32Î°ú Ï†ÑÏÜ° (${desiredOnOff}) - Ïä§ÏºÄÏ§ÑÎü¨ ÏöîÏ≤≠`);\n//         // Í≥ÑÏÜç ÏßÑÌñâ ‚Üí MQTT Î∞úÌñâ\n//     }\n// }\n\n// // ÏóêÏñ¥ÎåêÌçº Ï†úÏñ¥ Ï≤òÎ¶¨ (Í∏∞Ï°¥Í≥º ÎèôÏùº)\n// if (controlType === 'air_damper') {\n//     if (desiredMode === 'auto' && !desiredOnOff) {\n//         node.log(`ÏóêÏñ¥ÎåêÌçº ÏûêÎèô Î™®Îìú Ï†ÑÌôò: Ïò®ÎèÑ Ïä§ÏºÄÏ§ÑÎü¨Ïóê ÏúÑÏûÑ`);\n//         return null;\n//     }\n//     if (isManualControl) {\n//         node.log(`ÏóêÏñ¥ÎåêÌçº ÏàòÎèô Ï†úÏñ¥: Ï¶âÏãú ESP32Î°ú Ï†ÑÏÜ° (${desiredOnOff})`);\n//     }\n// }\n\n// // Î∞∞Í∏∞Ìå¨ÏùÄ Ìï≠ÏÉÅ Ï¶âÏãú Ï†úÏñ¥ (Í∏∞Ï°¥Í≥º ÎèôÏùº)\n// if (controlType === 'exhaust_fan') {\n//     node.log(`Î∞∞Í∏∞Ìå¨ Ï†úÏñ¥: Ï¶âÏãú ESP32Î°ú Ï†ÑÏÜ° (Î™®Îìú: ${desiredMode}, ÏÉÅÌÉú: ${desiredOnOff})`);\n// }\n\n// // controlType Í≤ÄÏ¶ù\n// if (!controlType || !['exhaust_fan', 'air_damper', 'led_drive', 'temperature_set'].includes(controlType)) {\n//     node.error(`ÏûòÎ™ªÎêú controlType: ${controlType}`);\n//     return null;\n// }\n\n// // MQTT ÌéòÏù¥Î°úÎìú Íµ¨ÏÑ± (Í∏∞Ï°¥Í≥º ÎèôÏùºÌïòÍ≤å Îã®ÏàúÌôî)\n// const payload = {\n//     type: `control_${controlType}`,\n//     controlType: controlType,\n//     mode: desiredMode,\n//     onoffValue: desiredOnOff,\n//     chamber_id: chamber,\n//     ts: new Date().toISOString(),\n    \n//     // ÏµúÏÜåÌïúÏùò Ï†úÏñ¥ ÏÜåÏä§ Íµ¨Î∂ÑÎßå\n//     control_source: (desiredMode === 'auto' && desiredOnOff) ? 'auto_scheduler' : 'manual_ui',\n    \n//     // Ï∂îÍ∞Ä ÏÑ§Ï†ïÍ∞íÎì§\n//     lightSetPoint: q.lightSetPoint ? Number(q.lightSetPoint) : undefined,\n//     avg_time: q.avg_time ? parseInt(q.avg_time) : undefined,\n//     hysteresis_wm2: q.hysteresis_wm2 ? Number(q.hysteresis_wm2) : undefined,\n//     min_on_sec: q.min_on_sec ? parseInt(q.min_on_sec) : undefined,\n//     min_off_sec: q.min_off_sec ? parseInt(q.min_off_sec) : undefined,\n//     tempSetPoint: q.tempSetPoint ? Number(q.tempSetPoint) : undefined,\n//     hysteresis_temp: q.hysteresis_temp ? Number(q.hysteresis_temp) : undefined\n// };\n\n// // undefined Í∞í Ï†úÍ±∞\n// Object.keys(payload).forEach(key => {\n//     if (payload[key] === undefined) {\n//         delete payload[key];\n//     }\n// });\n\n// // ÌÜ†ÌîΩ ÏÉùÏÑ±\n// msg.topic = `kist/control/site_001/${chamber}/edgeKIST_001/${controlType}`;\n// msg.payload = JSON.stringify(payload);\n\n// // Ï∂îÍ∞Ä Î©îÌÉÄÎç∞Ïù¥ÌÑ∞\n// msg.headers = {\n//     'Content-Type': 'application/json',\n//     'User-Agent': 'NodeRED-MQTT-Publisher'\n// };\n\n// // ÏÉÅÏÑ∏ Î°úÍ∑∏\n// node.log(\"=== MQTT Î∞úÌñâ Ï†ïÎ≥¥ ===\");\n// node.log(`ÏµúÏ¢Ö controlType: ${controlType}`);\n// node.log(`ÏÉùÏÑ±Îêú ÌÜ†ÌîΩ: ${msg.topic}`);\n// node.log(`Î™®Îìú: ${desiredMode}, ÏÉÅÌÉú: ${desiredOnOff}`);\n\n// // Ï†úÏñ¥ Î™ÖÎ†π Î°úÍ∑∏\n// if (desiredOnOff) {\n//     if (payload.control_source === 'auto_scheduler') {\n//         node.log(`üü° ÏûêÎèô Ï†úÏñ¥ Î™ÖÎ†π: ${controlType} = ${desiredOnOff} (Ïä§ÏºÄÏ§ÑÎü¨)`);\n//     } else {\n//         node.log(`üîµ ÏàòÎèô Ï†úÏñ¥ Î™ÖÎ†π: ${controlType} = ${desiredOnOff} (ÏÇ¨Ïö©Ïûê)`);\n//     }\n// } else {\n//     node.log(`üü¢ Î™®Îìú ÏÑ§Ï†ï: ${controlType} = ${desiredMode} Î™®Îìú`);\n// }\n\n// return msg;\n\n\n\n// ÏûÖÎ†• ÌÜµÌï©(GET/POST)\nconst method = (msg.req && msg.req.method) || 'GET';\nconst qraw = method === 'POST' ? (msg.req.body || {}) : ((msg.req && msg.req.query) || {});\nconst q = Object.assign({}, qraw);\n\n// controlType/chamber Ï†ïÍ∑úÌôî\nconst controlType = String(q.controlType || q.type || '').trim();\nconst ALLOWED = ['exhaust_fan', 'air_damper', 'led_drive', 'temperature_set'];\nif (!ALLOWED.includes(controlType)) { node.error(`ÏûòÎ™ªÎêú controlType: \"${controlType}\"`); return null; }\n\nlet chamber = Array.isArray(q.chamber_id) ? q.chamber_id[0] : (q.chamber_id || 'chamber_001');\nchamber = String(chamber).trim();\n\n// Î™®Îìú/ÏÉÅÌÉú\nconst desiredMode = q.mode ? String(q.mode).toLowerCase() : undefined;\nconst desiredOnOff = (q.onoffValue != null && q.onoffValue !== '') ? String(q.onoffValue).toUpperCase() : undefined;\n\n// ÏûêÎèô Î™®ÎìúÏùº ÎïåÎäî Ï¶âÏãú MQTT Î∞úÌñâ Í∏àÏßÄ (LED/ÎåêÌçº/Ìå¨ Í≥µÌÜµ)\nif (desiredMode === 'auto') {\n  node.log(`${controlType} ÏûêÎèô Î™®Îìú: ÏÑ§Ï†ï Ï†ÄÏû•Îßå, Ï¶âÏãú MQTT Î∞úÌñâ ÏïàÌï® (chamber=${chamber})`);\n  return null;\n}\n\n// ÏàòÎèô Î™®ÎìúÏóêÏÑúÎßå, onoffValue Ï°¥Ïû¨ Ïãú Î∞úÌñâ\nif (desiredMode !== 'manual' || !desiredOnOff) {\n  node.log(`Ï¶âÏãú Î∞úÌñâ Ï°∞Í±¥ Î∂àÏ∂©Ï°±: mode=${desiredMode}, onoff=${desiredOnOff} (chamber=${chamber}, ${controlType})`);\n  return null;\n}\n\nconst payload = {\n  type: `control_${controlType}`,\n  controlType,\n  mode: desiredMode,\n  onoffValue: desiredOnOff,\n  lightSetPoint: q.lightSetPoint ? Number(q.lightSetPoint) : undefined,\n  avg_time: q.avg_time ? parseInt(q.avg_time, 10) : undefined,\n  tempSetPoint: q.tempSetPoint ? Number(q.tempSetPoint) : undefined,\n  chamber_id: chamber,\n  ts: new Date().toISOString(),\n  user_action: true\n};\n\nmsg.topic = `kist/control/site_001/${chamber}/edgeKIST_001/${controlType}`;\nmsg.payload = JSON.stringify(payload);\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 260,
        "wires": [
            [
                "ee4e662c5d8671d5",
                "76a425f8e15a6fa0"
            ]
        ]
    },
    {
        "id": "ee4e662c5d8671d5",
        "type": "mqtt out",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "Î∞úÌñâ (ÏÑ†ÌÉù)",
        "topic": "",
        "qos": "1",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "fe5f57faf4c94451",
        "x": 930,
        "y": 260,
        "wires": []
    },
    {
        "id": "4a207065043b3f66",
        "type": "function",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "HTTP 200 + CORS",
        "func": "// msg.statusCode = 200;\n// msg.headers = { 'Content-Type':'application/json; charset=utf-8', 'Access-Control-Allow-Origin':'*' };\n// msg.payload = { ok:true };\n// return msg;\n\nconst ok = (typeof msg.statusCode === 'number') ? (msg.statusCode >= 200 && msg.statusCode < 300) : true;\nmsg.headers = { 'Content-Type': 'application/json; charset=utf-8', 'Access-Control-Allow-Origin': '*', 'Cache-Control': 'no-store, max-age=0' };\nif (ok) { msg.statusCode = 200; msg.payload = { ok: true }; }\nelse { msg.statusCode = msg.statusCode || 502; msg.payload = { ok: false, error: (typeof msg.payload === 'string' ? msg.payload : 'write failed') }; }\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 300,
        "wires": [
            [
                "78cdc40e9fba583a"
            ]
        ]
    },
    {
        "id": "78cdc40e9fba583a",
        "type": "http response",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "HTTP ÏùëÎãµ",
        "statusCode": "",
        "headers": {},
        "x": 1270,
        "y": 420,
        "wires": []
    },
    {
        "id": "d8b9add44aec53d8",
        "type": "http in",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "GET /settings/latest",
        "url": "/settings/latest",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 230,
        "y": 460,
        "wires": [
            [
                "55c255bdfe39f899",
                "5081ec45d8b228dc"
            ]
        ]
    },
    {
        "id": "55c255bdfe39f899",
        "type": "function",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "Flux ÏÉùÏÑ± (Ï±îÎ≤ÑÎ≥Ñ ÎßàÏßÄÎßâ ÏÑ§Ï†ï)",
        "func": "// // ÏõêÎûò LEDÎßå Ï°∞ÌöåÌïòÎäî ÏΩîÎìúÎ°ú Î≥µÍµ¨\n// const chamber = (msg.req && msg.req.query && msg.req.query.chamber_id) || 'chamber_001';\n\n// msg.payload = `\n// from(bucket: \"KISTopenChamber\")\n//   |> range(start: -7d)\n//   |> filter(fn: (r) => \n//     r._measurement == \"kocControl\" and\n//     r.org_id == \"KIST\" and\n//     r.site_id == \"site_001\" and\n//     r.collector_id == \"edgeKIST_001\" and\n//     r.chamber_id == \"${chamber}\" and\n//     r.control_type == \"led_drive\")\n//   |> last()\n//   |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n//   |> map(fn: (r) => ({\n//     control_type: \"led_drive\",\n//     mode: r.mode,\n//     onoffValue: r.onoffValue,\n//     lightSetPoint: r.lightSetPoint,\n//     avg_time: r.avg_time,\n//     hysteresis_wm2: r.hysteresis_wm2,\n//     min_on_sec: r.min_on_sec,\n//     min_off_sec: r.min_off_sec,\n//     mode_time: string(v: r._time)\n//   }))\n// `;\n\n// return msg;\n\n\n// Function ÎÖ∏Îìú: \"Flux ÏÉùÏÑ± (Ï±îÎ≤ÑÎ≥Ñ ÎßàÏßÄÎßâ ÏÑ§Ï†ï)\" Ï†ÑÏ≤¥ ÍµêÏ≤¥\nconst chamber = (msg.req && msg.req.query && msg.req.query.chamber_id) || 'chamber_001';\n\nmsg.payload = `\ndata = from(bucket: \"KISTopenChamber\")\n  |> range(start: -30d)\n  |> filter(fn: (r) =>\n    r._measurement == \"kocControl\" and\n    r.org_id == \"KIST\" and\n    r.site_id == \"site_001\" and\n    r.collector_id == \"edgeKIST_001\" and\n    r.chamber_id == \"${chamber}\" and\n    (r.control_type == \"led_drive\" or r.control_type == \"air_damper\"))\n  |> keep(columns: [\"_time\",\"_field\",\"_value\",\"control_type\"])\n\ndata\n  |> group(columns: [\"control_type\",\"_field\"])\n  |> sort(columns: [\"_time\"], desc: true)\n  |> first()\n  |> group(columns: [\"control_type\"])\n  |> pivot(rowKey: [\"control_type\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n`;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 480,
        "y": 460,
        "wires": [
            [
                "0e9a8def99d66b67",
                "7d911a1625378316"
            ]
        ]
    },
    {
        "id": "0e9a8def99d66b67",
        "type": "http request",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "Influx Query (CSV)",
        "method": "POST",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "http://influxdb2:8086/api/v2/query?org=KIST",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/vnd.flux"
            },
            {
                "keyType": "Accept",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/csv"
            }
        ],
        "x": 730,
        "y": 460,
        "wires": [
            [
                "fbf9881a38147862",
                "803f4bab1d2dc534"
            ]
        ]
    },
    {
        "id": "fbf9881a38147862",
        "type": "function",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "CSV ‚Üí JSON (control_typeÎ≥Ñ)",
        "func": "// ÏôÑÏÑ±Îêú \"CSV ‚Üí JSON (control_typeÎ≥Ñ)\" ÎÖ∏Îìú ÏΩîÎìú\n// Í∞Å ÌïÑÎìúÎ≥ÑÎ°ú Í∞ÄÏû• ÏµúÏã†Ïùò Ïú†Ìö®Ìïú Í∞íÏùÑ ÏÑ†ÌÉùÌïòÏó¨ Ï°∞Ìï©\n\n\n// ÎîîÎ≤ÑÍπÖ: Î∞õÏùÄ CSV ÎÇ¥Ïö© ÌôïÏù∏\nconst csv = (msg.payload || '').trim();\nnode.log(\"=== CSV ÎîîÎ≤ÑÍπÖ ===\");\nnode.log(\"CSV Í∏∏Ïù¥: \" + csv.length);\nnode.log(\"CSV ÎÇ¥Ïö© (Ï≤´ 500Ïûê): \" + csv.substring(0, 500));\n\n\nconst settings = {};\n\nif (csv) {\n  const lines = csv.split(/\\r?\\n/).filter(Boolean);\n\n  if (lines.length < 2) {\n    // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ Îπà settings Î∞òÌôò\n    msg.statusCode = 200;\n    msg.headers = {\n      'Content-Type': 'application/json; charset=utf-8',\n      'Access-Control-Allow-Origin': '*',\n      'Cache-Control': 'no-store, max-age=0'\n    };\n    msg.payload = { ok: true, settings };\n    return msg;\n  }\n\n  const header = lines[0].split(',').map(s => s.trim());\n\n  // Í∞Å control_typeÎ≥ÑÎ°ú ÌïÑÎìúÎ≥Ñ ÏµúÏã†Í∞í Ï∂îÏ†Å\n  const fieldLatestValues = {};\n\n  for (let i = 1; i < lines.length; i++) {\n    const cols = lines[i].split(',');\n    const row = {};\n\n    // Ìó§ÎçîÏôÄ Îç∞Ïù¥ÌÑ∞ Îß§Ìïë\n    header.forEach((h, idx) => {\n      row[h] = cols[idx] === undefined ? null : cols[idx];\n    });\n\n    const controlType = row['control_type'] || 'led_drive';\n    const timestamp = row['mode_time'] || row['_time'] || new Date().toISOString();\n\n    // control_typeÎ≥Ñ Ï¥àÍ∏∞Ìôî\n    if (!fieldLatestValues[controlType]) {\n      fieldLatestValues[controlType] = {};\n    }\n\n    // Í∞Å ÌïÑÎìúÎ≥ÑÎ°ú Ïú†Ìö®Ìïú Í∞íÏù¥ ÏûàÏúºÎ©¥ ÏµúÏã†Í∞íÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏\n    Object.keys(row).forEach(field => {\n      const value = row[field];\n\n      // Ïú†Ìö®Ìïú Í∞íÏù∏ÏßÄ ÌôïÏù∏ (Îπà Î¨∏ÏûêÏó¥, null, undefined Ï†úÏô∏)\n      // CSV Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ ÌïÑÎìúÎäî Ï†úÏô∏\n      if (field !== '' &&\n        field !== 'result' &&\n        field !== 'table' &&\n        field !== '_result' &&\n        value != null &&\n        value !== '') {\n\n        // ÌòÑÏû¨ ÌïÑÎìúÏùò Ï†ÄÏû•Îêú Í∞íÏù¥ ÏóÜÍ±∞ÎÇò, Îçî ÏµúÏã† ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏\n        if (!fieldLatestValues[controlType][field] ||\n          timestamp >= fieldLatestValues[controlType][field].timestamp) {\n          fieldLatestValues[controlType][field] = {\n            value: value,\n            timestamp: timestamp\n          };\n        }\n      }\n    });\n  }\n\n  // ÏµúÏ¢Ö Í≤∞Í≥º ÏÉùÏÑ±\n  Object.keys(fieldLatestValues).forEach(controlType => {\n    const result = {};\n\n    Object.keys(fieldLatestValues[controlType]).forEach(field => {\n      let value = fieldLatestValues[controlType][field].value;\n\n      // Ïà´Ïûê ÌïÑÎìú ÌÉÄÏûÖ Î≥ÄÌôò\n      if (['tempSetPoint', 'lightSetPoint', 'avg_time', 'hysteresis_wm2', 'min_on_sec', 'min_off_sec'].includes(field)) {\n        const numValue = Number(value);\n        if (Number.isFinite(numValue)) {\n          value = numValue;\n        }\n      }\n\n      // Î¨∏ÏûêÏó¥ ÌïÑÎìú Ï†ïÎ¶¨ (Îπà Î¨∏ÏûêÏó¥ Ï†úÍ±∞)\n      if (['mode', 'onoffValue', 'current_state'].includes(field)) {\n        if (value === '' || value == null) {\n          return; // Ïù¥ ÌïÑÎìúÎäî Í≤∞Í≥ºÏóê Ìè¨Ìï®ÌïòÏßÄ ÏïäÏùå\n        }\n      }\n\n      // mode_timeÏùÄ ISO Î¨∏ÏûêÏó¥ Í∑∏ÎåÄÎ°ú Î≥¥Ï°¥\n      if (field === 'mode_time') {\n        value = String(value);\n      }\n\n      result[field] = value;\n    });\n\n    // *** LED ÏÉÅÌÉú ÌïÑÎìú Ï≤òÎ¶¨ - ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ ***\n    let finalLedStatus = null;\n    \n    // 1. ÏÉÅÌÉú ÌïÑÎìú Ïö∞ÏÑ†ÏàúÏúÑ: current_state > onoffValue > light_text\n    if (result.current_state && result.current_state !== '') {\n      finalLedStatus = String(result.current_state).toUpperCase();\n      // onoffValueÍ∞Ä ÏóÜÏúºÎ©¥ current_state Í∞íÏúºÎ°ú ÏÑ§Ï†ï\n      if (!result.onoffValue || result.onoffValue === '') {\n        result.onoffValue = result.current_state;\n      }\n    } else if (result.onoffValue && result.onoffValue !== '') {\n      finalLedStatus = String(result.onoffValue).toUpperCase();\n    } else if (result.light_text && result.light_text !== '') {\n      const lightText = String(result.light_text).toUpperCase();\n      if (lightText.includes('ON')) {\n        finalLedStatus = 'ON';\n        result.onoffValue = 'ON';\n      } else if (lightText.includes('OFF')) {\n        finalLedStatus = 'OFF';\n        result.onoffValue = 'OFF';\n      }\n    }\n    \n    // 2. current_stateÎäî ÏÇ≠Ï†úÌïòÏßÄ ÏïäÍ≥† Î≥¥Ï°¥ (ÎîîÎ≤ÑÍπÖ Î∞è Ìò∏ÌôòÏÑ± ÏúÑÌï¥)\n    // Í∏∞Ï°¥: delete result.current_state; ‚Üê Ïù¥ Ï§ÑÏùÑ Ï†úÍ±∞Ìï®\n    \n    // 3. ÏµúÏ¢Ö ÏÉÅÌÉúÍ∞í Î°úÍπÖ Î∞è Í≤ÄÏ¶ù\n    if (finalLedStatus && (finalLedStatus === 'ON' || finalLedStatus === 'OFF')) {\n      node.log(`Ï±îÎ≤Ñ ${controlType}: ÏµúÏ¢Ö LED ÏÉÅÌÉú = ${finalLedStatus} (current_state: ${result.current_state}, onoffValue: ${result.onoffValue})`);\n    } else if (controlType === 'led_drive') {\n      node.log(`Ï±îÎ≤Ñ ${controlType}: LED ÏÉÅÌÉú Î∂àÎ™ÖÌôï - current_state: ${result.current_state}, onoffValue: ${result.onoffValue}, light_text: ${result.light_text}`);\n    }\n\n    // ÏµúÏÜåÌïúÏùò ÌïÑÏàò ÌïÑÎìúÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏\n    if (Object.keys(result).length > 1) { // control_type Ïô∏Ïóê Îã§Î•∏ ÌïÑÎìúÍ∞Ä ÏûàÏñ¥Ïïº Ìï®\n      settings[controlType] = result;\n    }\n  });\n}\n\n// HTTP ÏùëÎãµ ÏÉùÏÑ±\nmsg.statusCode = 200;\nmsg.headers = {\n  'Content-Type': 'application/json; charset=utf-8',\n  'Access-Control-Allow-Origin': '*',\n  'Cache-Control': 'no-store, max-age=0'\n};\nmsg.payload = { ok: true, settings };\n\n// ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏ (ÌïÑÏöîÏãú Ï†úÍ±∞)\nif (settings.led_drive) {\n  node.log(`LED ÏÑ§Ï†ï ÌååÏã± ÏôÑÎ£å: ${JSON.stringify(settings.led_drive)}`);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 990,
        "y": 460,
        "wires": [
            [
                "78cdc40e9fba583a",
                "995178d3ceb4e340"
            ]
        ]
    },
    {
        "id": "ad50927bb0251c45",
        "type": "http in",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "GET /ui-selection",
        "url": "/ui-selection",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 220,
        "y": 600,
        "wires": [
            [
                "2484c47957020565"
            ]
        ]
    },
    {
        "id": "2484c47957020565",
        "type": "function",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "UI ÏÑ†ÌÉùÍ∞í ‚Üí LP",
        "func": "const q = (msg.req && msg.req.query) || {};\nconst ui = q.ui || 'chamber_id';\nconst value = q.value || 'chamber_001';\nconst tags = [ 'org_id=KIST','site_id=site_001',`ui=${ui}` ].join(',');\nconst fields = `value=\\\"${String(value).replace(/\"/g,'\\\\\"')}\\\"`;\nmsg.payload = `kocUi,${tags} ${fields}`;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 440,
        "y": 600,
        "wires": [
            [
                "0818df55bd821146"
            ]
        ]
    },
    {
        "id": "0818df55bd821146",
        "type": "http request",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "Influx Write (kocUi)",
        "method": "POST",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "http://influxdb2:8086/api/v2/write?org=KIST&bucket=KISTopenChamber&precision=ns",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "text/plain; charset=utf-8"
            },
            {
                "keyType": "Accept",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 730,
        "y": 600,
        "wires": [
            [
                "71ca32de0e0b44da",
                "5eb35b6882775774"
            ]
        ]
    },
    {
        "id": "71ca32de0e0b44da",
        "type": "function",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "HTTP 200 + CORS",
        "func": "msg.statusCode = 200;\nmsg.headers = {\n  'Content-Type':'application/json; charset=utf-8',\n  'Access-Control-Allow-Origin':'*',\n  'Cache-Control':'no-store, max-age=0'\n};\nmsg.payload = { ok:true };\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 600,
        "wires": [
            [
                "78cdc40e9fba583a",
                "8cc8e6776bb0a636"
            ]
        ]
    },
    {
        "id": "76131fcff9202188",
        "type": "comment",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "Ï±îÎ≤ÑÏÑ†ÌÉù",
        "info": "",
        "x": 200,
        "y": 560,
        "wires": []
    },
    {
        "id": "5eb35b6882775774",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "debug 1",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 920,
        "y": 560,
        "wires": []
    },
    {
        "id": "76a425f8e15a6fa0",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 920,
        "y": 220,
        "wires": []
    },
    {
        "id": "7d911a1625378316",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "debug 3",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 420,
        "wires": []
    },
    {
        "id": "803f4bab1d2dc534",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "debug 4",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 920,
        "y": 420,
        "wires": []
    },
    {
        "id": "5081ec45d8b228dc",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "debug 7",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 420,
        "y": 420,
        "wires": []
    },
    {
        "id": "8cf2a64b6d716ada",
        "type": "inject",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "Îß§ 1Î∂Ñ",
        "props": [],
        "repeat": "60",
        "crontab": "",
        "once": false,
        "onceDelay": "2",
        "topic": "",
        "x": 220,
        "y": 840,
        "wires": [
            [
                "3a89902a6985b302"
            ]
        ]
    },
    {
        "id": "3a89902a6985b302",
        "type": "function",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "Ï±îÎ≤Ñ Î™©Î°ù fan-out",
        "func": "// // ÌïÑÏöî Ïãú Ïã§Ï†ú Î≥¥Ïú† Ï±îÎ≤Ñ Î™©Î°ùÏúºÎ°ú ÍµêÏ≤¥\n// const chambers = [\n//   'chamber_001','chamber_002','chamber_003','chamber_004','chamber_005',\n//   'chamber_006','chamber_007','chamber_008','chamber_009','chamber_010'\n// ];\n// return [ chambers.map(ch => ({ chamber_id: ch, payload: {} })) ];\n\n\n// Ïã§Ï†ú Ï°¥Ïû¨ÌïòÎäî Ï±îÎ≤ÑÎßå ÎèôÏ†ÅÏúºÎ°ú ÌôïÏù∏ÌïòÏó¨ Î™©Î°ù ÏÉùÏÑ±\n// Ìñ•ÌõÑ Ï±îÎ≤Ñ Ï∂îÍ∞Ä/Ï†úÍ±∞ Ïãú ÏûêÎèôÏúºÎ°ú Î∞òÏòÅÎê®\n\n// Î∞©Î≤ï 1: Í≥†Ï†ï Î™©Î°ù (ÌòÑÏû¨ Ï°¥Ïû¨ÌïòÎäî Ï±îÎ≤ÑÎßå)\nconst existingChambers = ['chamber_001']; // Ïã§Ï†ú Ï°¥Ïû¨ÌïòÎäî Ï±îÎ≤ÑÎßå Î™ÖÏãú\n\n// Î∞©Î≤ï 2: InfluxDBÏóêÏÑú Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäî Ï±îÎ≤Ñ Î™©Î°ùÏùÑ ÎèôÏ†ÅÏúºÎ°ú Í∞ÄÏ†∏Ïò§Í∏∞ (Ï∂îÏ≤ú)\n// Ïù¥ Í≤ΩÏö∞ HTTP Request ÎÖ∏ÎìúÎ°ú InfluxDB ÏøºÎ¶¨ ÌïÑÏöî\n\n// ÌòÑÏû¨Îäî Î∞©Î≤ï 1 ÏÇ¨Ïö©\nreturn [existingChambers.map(ch => ({ chamber_id: ch, payload: {} }))];",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 840,
        "wires": [
            [
                "aa879e41d0778374"
            ]
        ]
    },
    {
        "id": "aa879e41d0778374",
        "type": "http request",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "GET /settings/latest",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://127.0.0.1:1880/settings/latest?chamber_id={{{chamber_id}}}",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": true,
        "headers": [],
        "x": 610,
        "y": 840,
        "wires": [
            [
                "673f3a0797c8b4d0"
            ]
        ]
    },
    {
        "id": "673f3a0797c8b4d0",
        "type": "function",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "ÏÑ§Ï†ï Í∫ºÎÇ¥Í∏∞+Í∏∞Î≥∏Í∞í",
        "func": "// ÏàòÏ†ïÎêú \"ÏÑ§Ï†ï Í∫ºÎÇ¥Í∏∞+Í∏∞Î≥∏Í∞í\" ÎÖ∏Îìú\n// ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ§Ï†ïÌïú avg_timeÏùÑ Ï†ïÌôïÌûà Î∞òÏòÅ\n\nconst chamber = msg.chamber_id || 'chamber_001';\n\n// HTTP ÏùëÎãµÏóêÏÑú ÏÑ§Ï†ïÍ∞í Ï∂îÏ∂ú\nconst S = (msg.payload && msg.payload.settings && msg.payload.settings.led_drive) || {};\n\nnode.log(`Ï±îÎ≤Ñ ${chamber}: Î∞õÏùÄ ÏÑ§Ï†ï = ${JSON.stringify(S)}`);\n\nconst cfg = {\n  mode: S.mode || 'manual',\n  threshold: Number(S.lightSetPoint ?? 300),\n  avgMin: Number(S.avg_time ?? 15),\n  hysteresis: Number(S.hysteresis_wm2 ?? 30),\n  minOn: Number(S.min_on_sec ?? 600),\n  minOff: Number(S.min_off_sec ?? 300)\n};\n\nnode.log(`Ï±îÎ≤Ñ ${chamber}: ÏÑ§Ï†ï cfg = ${JSON.stringify(cfg)}`);\n\nmsg.ledCfg = cfg;\nmsg.chamber_id = chamber;\n\n// ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï avg_timeÏùÑ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö© (ÏµúÏÜå/ÏµúÎåÄ Ï†úÌïú ÏôÑÌôî)\n// ÏµúÏÜå 1Î∂Ñ, ÏµúÎåÄ 1440Î∂Ñ(24ÏãúÍ∞Ñ)ÏúºÎ°ú Ìï©Î¶¨Ï†Å Î≤îÏúÑ ÏÑ§Ï†ï\nconst userAvgTime = Math.min(1440, Math.max(1, Math.floor(cfg.avgMin)));\n\nnode.log(`Ï±îÎ≤Ñ ${chamber}: ÏÇ¨Ïö©Ïûê avg_time = ${cfg.avgMin}Î∂Ñ, Ï†ÅÏö©Í∞í = ${userAvgTime}Î∂Ñ`);\n\nmsg.headers = {\n  'Content-Type': 'application/vnd.flux',\n  'Accept': 'application/csv'\n};\n\n// Flux ÏøºÎ¶¨ÏóêÏÑú ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï ÏãúÍ∞Ñ Ï†ÅÏö©\nmsg.payload = `from(bucket: \"KISTopenChamber\")\n  |> range(start: -${userAvgTime}m)\n  |> filter(fn: (r) => \n    r._measurement == \"kocData\" and\n    r.org_id == \"KIST\" and\n    r.site_id == \"site_001\" and\n    r.collector_id == \"edgeKIST_001\" and\n    r.chamber_id == \"${chamber}\" and\n    r._field == \"pyrRaw\"\n  )\n  |> mean()\n  |> keep(columns: [\"_value\"])`;\n\n// LED ÌòÑÏû¨ ÏÉÅÌÉú Ï°∞ÌöåÎ•º ÏúÑÌïú Ï∂îÍ∞Ä Ï†ïÎ≥¥\nmsg.needLedState = true;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 830,
        "y": 840,
        "wires": [
            [
                "b6216ada7262ba43"
            ]
        ]
    },
    {
        "id": "b6216ada7262ba43",
        "type": "http request",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "Influx Query(mean pyrRaw)",
        "method": "POST",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "http://influxdb2:8086/api/v2/query?org=KIST",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/vnd.flux"
            },
            {
                "keyType": "Accept",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/csv"
            }
        ],
        "x": 1080,
        "y": 840,
        "wires": [
            [
                "632e69b6f7bdb6f9",
                "6e6ed4a6768adcb4"
            ]
        ]
    },
    {
        "id": "4d35ed9bcd602442",
        "type": "mqtt out",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "Ï†úÏñ¥ Î∞úÌñâ",
        "topic": "",
        "qos": "1",
        "retain": "false",
        "broker": "fe5f57faf4c94451",
        "x": 1600,
        "y": 780,
        "wires": []
    },
    {
        "id": "58e1418482a73281",
        "type": "http request",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "Influx Write (Ï†úÏñ¥Î°úÍ∑∏)",
        "method": "POST",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "http://influxdb2:8086/api/v2/write?org=KIST&bucket=KISTopenChamber&precision=ns",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": true,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "text/plain; charset=utf-8"
            }
        ],
        "x": 1640,
        "y": 840,
        "wires": [
            [
                "2e2269c888b6ee71"
            ]
        ]
    },
    {
        "id": "2e2269c888b6ee71",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "ÏóêÎü¨/ÏùëÎãµ ÌôïÏù∏",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1840,
        "y": 840,
        "wires": []
    },
    {
        "id": "8cc8e6776bb0a636",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "debug 8",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1140,
        "y": 600,
        "wires": []
    },
    {
        "id": "632e69b6f7bdb6f9",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "debug 10",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1300,
        "y": 700,
        "wires": []
    },
    {
        "id": "0c9ba8e611513469",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "debug 9",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1600,
        "y": 740,
        "wires": []
    },
    {
        "id": "e162ec732c40e7a1",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "debug 11",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1600,
        "y": 880,
        "wires": []
    },
    {
        "id": "f8f835d564e9c2ca",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "debug 12",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 220,
        "wires": []
    },
    {
        "id": "995178d3ceb4e340",
        "type": "debug",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "debug 13",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1260,
        "y": 460,
        "wires": []
    },
    {
        "id": "576798779c4637a9",
        "type": "comment",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "ÏàòÏ†ï",
        "info": "",
        "x": 1290,
        "y": 880,
        "wires": []
    },
    {
        "id": "6e6ed4a6768adcb4",
        "type": "function",
        "z": "e8cc38a9cd1fb99d",
        "d": true,
        "name": "CSV‚ÜíavgPyr, ÌåêÎã®2_New",
        "func": "// // LED ÏûêÎèô Ï†úÏñ¥ (Ï†ïÏãú/Ï£ºÍ∏∞ Ïã§Ìñâ, avg_time Î∂ÑÎßàÎã§ 1Ìöå ÌèâÍ∞Ä)\n// // - ÏßÅÏ†Ñ avg_timeÎ∂Ñ ÌèâÍ∑† ÏùºÏÇ¨Îüâ(mean)Îßå Ï°∞Ìöå\n// // - mean < thresholdÏù¥Î©¥ ON, mean >= thresholdÏù¥Î©¥ OFF\n// // - ÌûàÏä§ÌÖåÎ¶¨ÏãúÏä§/ÏµúÏÜå ON/OFF ÏãúÍ∞ÑÏùÄ ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå(ÏöîÏ≤≠ Î∞©Ïãù)\n\n// const OVERRIDE_TTL_MS = 30 * 60 * 1000;\n// const UI_GRACE_MS = 5000;\n\n// const chamber = msg.chamber_id || 'unknown';\n// const csvText = (msg.payload || '').trim();\n// const now = Date.now();\n\n// node.log(`=== [${chamber}] LED Ï†ïÏãú Ï†úÏñ¥ ÏãúÏûë ===`);\n\n// // 0) UI ÏßÅÌõÑ Î≥¥Ìò∏Íµ¨Í∞Ñ\n// const uiWriteKey = `last_ui_write_${chamber}_led_drive`;\n// const lastUiWrite = context.get(uiWriteKey);\n// if (lastUiWrite && (now - lastUiWrite) < UI_GRACE_MS) {\n//   node.log(`[${chamber}] UI ÏßÅÌõÑ Î≥¥Ìò∏Íµ¨Í∞Ñ - ÏûêÎèô Ï†úÏñ¥ Ïä§ÌÇµ`);\n//   return [null, null];\n// }\n\n// // 1) ÏàòÎèô Ïò§Î≤ÑÎùºÏù¥Îìú(30Î∂Ñ) Ïö∞ÏÑ†\n// const ovKey = `manual_override_${chamber}_led_drive`;\n// const ov = context.get(ovKey);\n// if (ov && (now - ov.timestamp) < OVERRIDE_TTL_MS) {\n//   node.log(`[${chamber}] ÏàòÎèô Ïò§Î≤ÑÎùºÏù¥Îìú ÌôúÏÑ± - ÏûêÎèô Ï†úÏñ¥ Ï§ëÎã®`);\n//   return [null, null];\n// }\n\n// // 2) ÏÑ§Ï†ï\n// const cfg = msg.ledCfg || {};\n// const mode = String(cfg.mode || 'manual').toLowerCase();\n// const threshold = Number(cfg.threshold) || 300;\n// const avgMinutes = Math.max(1, Number(cfg.avgMin) || 15); // 1Î∂Ñ Ïù¥ÏÉÅ\n\n// if (mode !== 'auto') {\n//   node.log(`[${chamber}] ÎπÑÏûêÎèô Î™®Îìú(${mode}) - ÏûêÎèô Ï†úÏñ¥ Ï§ëÎã®`);\n//   return [null, null];\n// }\n\n// // 3) Ï†ïÏãú Ïä§ÏºÄÏ§Ñ: ÎßàÏßÄÎßâ Ïã§Ìñâ ÏãúÏ†ê Í∏∞Ï§Ä Ï†ïÌôïÌûà avgMinutes Î∂ÑÎßàÎã§ 1Ìöå\n// const schedKey = `strict_led_schedule_${chamber}`;\n// let sched = context.get(schedKey) || { lastRun: 0, nextRun: now + (avgMinutes * 60 * 1000), intervalMs: avgMinutes * 60 * 1000 };\n\n// // avg_time Î≥ÄÍ≤Ω Î∞òÏòÅ\n// const desiredInterval = avgMinutes * 60 * 1000;\n// if (sched.intervalMs !== desiredInterval) {\n//   node.log(`[${chamber}] Ï£ºÍ∏∞ Î≥ÄÍ≤Ω: ${Math.round(sched.intervalMs/60000)}Î∂Ñ ‚Üí ${avgMinutes}Î∂Ñ`);\n//   sched.intervalMs = desiredInterval;\n//   // Îã§Ïùå Ïã§ÌñâÏùÄ ÏÉà Ï£ºÍ∏∞Î°ú ÏòàÏïΩ\n//   sched.nextRun = now + desiredInterval;\n// }\n\n// // ÏïÑÏßÅ ÏãúÍ∞ÑÏù¥ Ïïà ÎêêÏúºÎ©¥ Ïä§ÌÇµ\n// if (now < sched.nextRun) {\n//   const sec = Math.round((sched.nextRun - now) / 1000);\n//   node.log(`[${chamber}] ÎåÄÍ∏∞Ï§ë - ${sec}Ï¥à ÌõÑ ÌèâÍ∞Ä(Ï£ºÍ∏∞=${avgMinutes}Î∂Ñ)`);\n//   context.set(schedKey, sched);\n//   return [null, null];\n// }\n\n// // Ïã§Ìñâ ÏãúÍ∞Å ÎèÑÎã¨ ‚Üí Îã§Ïùå Ïã§Ìñâ ÏòàÏïΩ\n// sched.lastRun = now;\n// sched.nextRun = now + sched.intervalMs;\n// context.set(schedKey, sched);\n\n// node.log(`[${chamber}] ÌèâÍ∞Ä Ïã§Ìñâ(Ï£ºÍ∏∞=${avgMinutes}Î∂Ñ), Îã§Ïùå: ${new Date(sched.nextRun).toLocaleString()}`);\n\n// // 4) Influx ÏøºÎ¶¨ Í≤∞Í≥º(CSV)ÏóêÏÑú mean(_value) ÏùΩÍ∏∞\n// let avgPyr = NaN;\n// try {\n//   if (csvText && csvText.length > 0) {\n//     const lines = csvText.split(/\\r?\\n/).filter(Boolean);\n//     if (lines.length >= 2) {\n//       const header = lines[0].split(',');\n//       const data = lines[1].split(',');\n//       const idx = header.indexOf('_value');\n//       if (idx >= 0 && data[idx] !== undefined) {\n//         avgPyr = parseFloat(data[idx]);\n//       }\n//     }\n//   }\n// } catch (e) {\n//   node.error(`[${chamber}] CSV ÌååÏã± Ïò§Î•ò: ${e.message}`);\n// }\n\n// if (!Number.isFinite(avgPyr)) {\n//   node.log(`[${chamber}] ÌèâÍ∑† ÏùºÏÇ¨Îüâ ÏóÜÏùå/Î¨¥Ìö® - Ï†úÏñ¥ Ïä§ÌÇµ`);\n//   return [null, null];\n// }\n\n// // 5) Îã®Ïàú ÎπÑÍµêÎ°ú Ï†úÏñ¥ Í≤∞Ï†ï\n// // ÏöîÏ≤≠: mean < threshold ‚Üí ON, mean >= threshold ‚Üí OFF\n// const desired = (avgPyr < threshold) ? 'ON' : 'OFF';\n// const stateKey = `led_state_${chamber}`;\n// let ledState = context.get(stateKey) || { current: 'OFF', lastChangeTime: now, lastSyncTime: now };\n\n// let controlAction = null;\n// let reason = `ÌèâÍ∑†=${avgPyr.toFixed(2)} vs Í∏∞Ï§Ä=${threshold} ‚Üí ${desired}`;\n\n// if (ledState.current !== desired) {\n//   controlAction = desired;\n//   ledState.current = desired;\n//   ledState.lastChangeTime = now;\n// }\n// ledState.lastSyncTime = now;\n// context.set(stateKey, ledState);\n\n// // 6) MQTT(ESP32) - ÏÉÅÌÉúÍ∞Ä Î∞îÎÄî ÎïåÎßå Î∞úÌñâ\n// let mqttMessage = null;\n// if (controlAction) {\n//   const mqttPayload = {\n//     type: 'control_led_drive',\n//     controlType: 'led_drive',\n//     mode: 'auto',\n//     onoffValue: controlAction,\n//     chamber_id: chamber,\n//     ts: new Date().toISOString(),\n//     auto_control: true,\n//     avg_time_minutes: avgMinutes,\n//     avg_pyr: Number(avgPyr.toFixed(3)),\n//     threshold\n//   };\n//   mqttMessage = {\n//     topic: `kist/control/site_001/${chamber}/edgeKIST_001/led_drive`,\n//     payload: JSON.stringify(mqttPayload)\n//   };\n// }\n\n// // 7) Influx Ï†úÏñ¥ Î°úÍ∑∏(Ìï≠ÏÉÅ Í∏∞Î°ù: ÏÉÅÌÉúÎ≥ÄÍ≤Ω Ïú†Î¨¥ÏôÄ Ïù¥Ïú† Ìè¨Ìï®)\n// const fields = [\n//   `reason=\"${reason.replace(/\"/g,'\\\\\"')}\"`,\n//   `mode=\"auto\"`,\n//   `current_state=\"${ledState.current}\"`,\n//   `onoffValue=\"${ledState.current}\"`,\n//   `avg_pyr=${avgPyr.toFixed(3)}`,\n//   `threshold=${threshold}`,\n//   `avg_time=${avgMinutes}i`,\n//   `control_source=\"strict_scheduler\"`,\n//   `action_taken=${controlAction ? '1i' : '0i'}`\n// ];\n\n// const influxMessage = {\n//   payload: `kocControl,org_id=KIST,site_id=site_001,collector_id=edgeKIST_001,chamber_id=${chamber},control_type=led_drive,source=node-red,result=OK ${fields.join(',')} ${now}000000`\n// };\n\n// if (controlAction) {\n//   node.log(`[${chamber}] LED ${controlAction} Ïã§Ìñâ - ${reason}`);\n// } else {\n//   node.log(`[${chamber}] LED ÏÉÅÌÉúÏú†ÏßÄ(${ledState.current}) - ${reason}`);\n// }\n\n// return [mqttMessage, influxMessage];\n\n\n// LED ÏûêÎèô Ï†úÏñ¥ (avg_time Î∂ÑÎßàÎã§ 1Ìöå ÌèâÍ∞Ä, ÏõåÏπòÎèÖ Ìè¨Ìï®)\n// - ÏßÅÏ†Ñ avg_timeÎ∂Ñ ÌèâÍ∑† ÏùºÏÇ¨Îüâ(mean)Îßå Ï°∞Ìöå (Influx mean Í≤∞Í≥ºÎ•º CSVÎ°ú Ï†ÑÎã¨Î∞õÏùå)\n// - mean < threshold ‚Üí ON, mean >= threshold ‚Üí OFF\n// - ÏõåÏπòÎèÖ: nextRun ÎπÑÏ†ïÏÉÅ/Í≥†Ï∞© Ïãú ÏûêÎèô Î≥µÍµ¨\n\nconst OVERRIDE_TTL_MS = 30 * 60 * 1000;\nconst UI_GRACE_MS = 5000;\n\nconst chamber = msg.chamber_id || 'unknown';\nconst csvText = (msg.payload || '').trim();\nconst now = Date.now();\n\nnode.log(`=== [${chamber}] LED Ï†ïÏãú Ï†úÏñ¥ ÏãúÏûë ===`);\n\n// 0) UI ÏßÅÌõÑ Î≥¥Ìò∏Íµ¨Í∞Ñ\nconst uiWriteKey = `last_ui_write_${chamber}_led_drive`;\nconst lastUiWrite = context.get(uiWriteKey);\nif (lastUiWrite && (now - lastUiWrite) < UI_GRACE_MS) {\n  node.log(`[${chamber}] UI ÏßÅÌõÑ Î≥¥Ìò∏Íµ¨Í∞Ñ - ÏûêÎèô Ï†úÏñ¥ Ïä§ÌÇµ`);\n  return [null, null];\n}\n\n// 1) ÏàòÎèô Ïò§Î≤ÑÎùºÏù¥Îìú(30Î∂Ñ) Ïö∞ÏÑ†\nconst ovKey = `manual_override_${chamber}_led_drive`;\nconst ov = context.get(ovKey);\nif (ov && (now - ov.timestamp) < OVERRIDE_TTL_MS) {\n  node.log(`[${chamber}] ÏàòÎèô Ïò§Î≤ÑÎùºÏù¥Îìú ÌôúÏÑ± - ÏûêÎèô Ï†úÏñ¥ Ï§ëÎã®`);\n  return [null, null];\n}\n\n// 2) ÏÑ§Ï†ï\nconst cfg = msg.ledCfg || {};\nconst mode = String(cfg.mode || 'manual').toLowerCase();\nconst threshold = Number(cfg.threshold) || 300;\nconst avgMinutes = Math.max(1, Number(cfg.avgMin) || 15); // 1Î∂Ñ Ïù¥ÏÉÅ\n\nif (mode !== 'auto') {\n  node.log(`[${chamber}] ÎπÑÏûêÎèô Î™®Îìú(${mode}) - ÏûêÎèô Ï†úÏñ¥ Ï§ëÎã®`);\n  return [null, null];\n}\n\n// 3) Ï†ïÏãú Ïä§ÏºÄÏ§Ñ: avg_time Î∂ÑÎßàÎã§ 1Ìöå\nconst intervalMs = avgMinutes * 60 * 1000;\nconst schedKey = `strict_led_schedule_${chamber}`;\nlet sched = context.get(schedKey);\n\n// ÏµúÏ¥à ÏÉùÏÑ±\nif (!sched) {\n  sched = { lastRun: 0, nextRun: now + intervalMs, intervalMs };\n  context.set(schedKey, sched);\n  node.log(`[${chamber}] Ïä§ÏºÄÏ§Ñ Ï¥àÍ∏∞Ìôî ‚Üí ${Math.round(intervalMs / 60000)}Î∂Ñ ÌõÑ Ï≤´ ÌèâÍ∞Ä`);\n} else {\n  // avg_time Î≥ÄÍ≤Ω Î∞òÏòÅ\n  if (sched.intervalMs !== intervalMs) {\n    node.log(`[${chamber}] Ï£ºÍ∏∞ Î≥ÄÍ≤Ω: ${Math.round((sched.intervalMs || intervalMs) / 60000)}Î∂Ñ ‚Üí ${avgMinutes}Î∂Ñ`);\n    sched.intervalMs = intervalMs;\n    // Îã§Ïùå Ïã§Ìñâ Ïû¨Í≥ÑÏÇ∞(Î≥ÄÍ≤Ω Ï¶âÏãú Îã§Ïùå Í∞ÑÍ≤© ÌõÑ ÌèâÍ∞Ä)\n    sched.nextRun = now + intervalMs;\n  }\n\n  // 3-a) ÏõåÏπòÎèÖ: nextRun ÎπÑÏ†ïÏÉÅ/Í≥†Ï∞© ÏûêÎèô Î≥µÍµ¨\n  const tooPast = sched.nextRun < (now - 24 * 60 * 60 * 1000);        // 24ÏãúÍ∞Ñ Ïù¥Ï†Ñ\n  const tooFuture = sched.nextRun > (now + 90 * 24 * 60 * 60 * 1000);   // 90Ïùº Ïù¥ÌõÑ\n  const invalid = !Number.isFinite(sched.nextRun);\n  if (invalid || tooPast || tooFuture) {\n    node.warn(`[${chamber}] ÏõåÏπòÎèÖ: nextRun ÎπÑÏ†ïÏÉÅ Í∞êÏßÄ (nextRun=${sched.nextRun}) ‚Üí Ï¥àÍ∏∞Ìôî`);\n    sched.lastRun = 0;\n    sched.nextRun = now + intervalMs;\n  }\n\n  // 3-b) (ÏòµÏÖò) Í∞ÑÍ≤© Í≤ΩÍ≥Ñ Ï†ïÎ†¨Î°ú Ïò§Ï∞® ÎàÑÏ†Å Î∞©ÏßÄ\n  // const aligned = Math.ceil(now / sched.intervalMs) * sched.intervalMs;\n  // sched.nextRun = aligned;\n  context.set(schedKey, sched);\n}\n\n// ÏïÑÏßÅ ÏãúÍ∞ÑÏù¥ Ïïà ÎêêÏúºÎ©¥ Ïä§ÌÇµ\nif (now < sched.nextRun) {\n  const sec = Math.round((sched.nextRun - now) / 1000);\n  node.log(`[${chamber}] ÎåÄÍ∏∞Ï§ë - ${sec}Ï¥à ÌõÑ ÌèâÍ∞Ä(Ï£ºÍ∏∞=${avgMinutes}Î∂Ñ)`);\n  return [null, null];\n}\n\n// Ïã§Ìñâ ÏãúÍ∞Å ÎèÑÎã¨ ‚Üí Îã§Ïùå Ïã§Ìñâ ÏòàÏïΩ\nsched.lastRun = now;\nsched.nextRun = now + sched.intervalMs;\ncontext.set(schedKey, sched);\nnode.log(`[${chamber}] ÌèâÍ∞Ä Ïã§Ìñâ(Ï£ºÍ∏∞=${avgMinutes}Î∂Ñ), Îã§Ïùå: ${new Date(sched.nextRun).toLocaleString()}`);\n\n// 4) Influx CSVÏóêÏÑú mean(_value) ÏùΩÍ∏∞\nlet avgPyr = NaN;\ntry {\n  if (csvText && csvText.length > 0) {\n    // const lines = csvText.split(/\\r?\\n/).filter(Boolean);\n    \n    const lines = csvText\n      .split(/\\r?\\n/)\n      .filter(line => line && !line.startsWith('#') && !line.startsWith('//'));\n\n    if (lines.length >= 2) {\n      const header = lines[0].split(',');\n      const data = lines[1].split(',');\n      const idx = header.indexOf('_value');\n      if (idx >= 0 && data[idx] !== undefined) {\n        avgPyr = parseFloat(data[idx]);\n      }\n    }\n  }\n} catch (e) {\n  node.error(`[${chamber}] CSV ÌååÏã± Ïò§Î•ò: ${e.message}`);\n}\n\nif (!Number.isFinite(avgPyr)) {\n  node.log(`[${chamber}] ÌèâÍ∑† ÏùºÏÇ¨Îüâ ÏóÜÏùå/Î¨¥Ìö® - Ï†úÏñ¥ Ïä§ÌÇµ`);\n  return [null, null];\n}\n\n// 5) Îã®Ïàú ÎπÑÍµêÎ°ú Ï†úÏñ¥ Í≤∞Ï†ï(mean < threshold ‚Üí ON, else OFF)\nconst desired = (avgPyr < threshold) ? 'ON' : 'OFF';\nconst stateKey = `led_state_${chamber}`;\nlet ledState = context.get(stateKey) || { current: 'OFF', lastChangeTime: now, lastSyncTime: now };\n\nlet controlAction = null;\nlet reason = `ÌèâÍ∑†=${avgPyr.toFixed(2)} vs Í∏∞Ï§Ä=${threshold} ‚Üí ${desired}`;\n\nif (ledState.current !== desired) {\n  controlAction = desired;\n  ledState.current = desired;\n  ledState.lastChangeTime = now;\n}\nledState.lastSyncTime = now;\ncontext.set(stateKey, ledState);\n\n// 6) MQTT(ESP32) - ÏÉÅÌÉúÍ∞Ä Î∞îÎÄî ÎïåÎßå Î∞úÌñâ\nlet mqttMessage = null;\nif (controlAction) {\n  const mqttPayload = {\n    type: 'control_led_drive',\n    controlType: 'led_drive',\n    mode: 'auto',\n    onoffValue: controlAction,\n    chamber_id: chamber,\n    ts: new Date().toISOString(),\n    auto_control: true,\n    avg_time_minutes: avgMinutes,\n    avg_pyr: Number(avgPyr.toFixed(3)),\n    threshold\n  };\n  mqttMessage = {\n    topic: `kist/control/site_001/${chamber}/edgeKIST_001/led_drive`,\n    payload: JSON.stringify(mqttPayload)\n  };\n}\n\n// 7) Influx Ï†úÏñ¥ Î°úÍ∑∏(Ìï≠ÏÉÅ Í∏∞Î°ù)\nconst fields = [\n  `reason=\"${reason.replace(/\"/g, '\\\\\"')}\"`,\n  `mode=\"auto\"`,\n  `current_state=\"${ledState.current}\"`,\n  `onoffValue=\"${ledState.current}\"`,\n  `avg_pyr=${avgPyr.toFixed(3)}`,\n  `threshold=${threshold}`,\n  `avg_time=${avgMinutes}i`,\n  `control_source=\"strict_scheduler\"`,\n  `action_taken=${controlAction ? '1i' : '0i'}`\n];\n\nconst influxMessage = {\n  payload: `kocControl,org_id=KIST,site_id=site_001,collector_id=edgeKIST_001,chamber_id=${chamber},control_type=led_drive,source=node-red,result=OK ${fields.join(',')} ${now}000000`\n};\n\nif (controlAction) {\n  node.log(`[${chamber}] LED ${controlAction} Ïã§Ìñâ - ${reason}`);\n} else {\n  node.log(`[${chamber}] LED ÏÉÅÌÉúÏú†ÏßÄ(${ledState.current}) - ${reason}`);\n}\n\nreturn [mqttMessage, influxMessage];",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1350,
        "y": 840,
        "wires": [
            [
                "4d35ed9bcd602442",
                "0c9ba8e611513469"
            ],
            [
                "58e1418482a73281",
                "e162ec732c40e7a1"
            ]
        ]
    },
    {
        "id": "6ad95895c93774d2",
        "type": "mqtt in",
        "z": "2ced808b3820b5c5",
        "name": "ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ ÏàòÏã†",
        "topic": "kist/+/+/+/telemetry/minute",
        "qos": "0",
        "datatype": "json",
        "broker": "fe5f57faf4c94451",
        "inputs": 0,
        "x": 280,
        "y": 120,
        "wires": [
            [
                "7b8c936037204bf6",
                "04d485e51e861589"
            ]
        ]
    },
    {
        "id": "7b8c936037204bf6",
        "type": "function",
        "z": "2ced808b3820b5c5",
        "name": "ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•",
        "func": "const p = (typeof msg.payload === 'string') ? JSON.parse(msg.payload) : (msg.payload || {});\nconst m = /^kist\\/([^/]+)\\/([^/]+)\\/([^/]+)\\/telemetry\\/minute$/.exec(msg.topic || \"\");\nif (!m) { node.log(\"Unexpected topic: \" + msg.topic); return null; }\nconst [_, site_id, chamber_id, collector_id] = m;\n\nif (collector_id === 'edgeKIST') {\n    node.log(\"Ignoring edgeKIST topic: \" + msg.topic);\n    return null;\n}\n\np.org_id = p.org_id || \"KIST\";\np.site_id = p.site_id || site_id;\np.chamber_id = p.chamber_id || chamber_id;\np.collector_id = p.collector_id || collector_id;\np.fw_version = p.fw_version || \"unknown\";\np.sensors = p.sensors || {};\n\np.timestamp = new Date().toISOString();\n\nconst tsMs = Date.parse(p.timestamp);\nconst tsNs = (BigInt(tsMs) * 1000000n).toString();\n\nfunction escTag(v) {\n    return String(v).replace(/[\\s,=]/g, \"\\\\$&\");\n}\n\nfunction fFloat(k, v) {\n    const n = Number(v);\n    return Number.isFinite(n) ? `${k}=${n}` : null;\n}\n\nconst tagsData = [\n    `org_id=${escTag(p.org_id)}`,\n    `site_id=${escTag(p.site_id)}`,\n    `chamber_id=${escTag(p.chamber_id)}`,\n    `collector_id=${escTag(p.collector_id)}`,\n    `fw_version=${escTag(p.fw_version)}`\n].join(\",\");\n\nconst fieldsData = [\n    fFloat(\"pyrRaw\", p.sensors.pyrRaw),\n    fFloat(\"tRaw\", p.sensors.tRaw),\n    fFloat(\"hRaw\", p.sensors.hRaw),\n    fFloat(\"co2Raw\", p.sensors.co2Raw),\n    fFloat(\"tBME\", p.sensors.tBME),\n    fFloat(\"hBME\", p.sensors.hBME)\n].filter(Boolean);\n\nif (!p.sensors.pyrRaw) {\n    node.log(`[${chamber_id}] pyrRaw ÏóÜÏùå - Îç∞Ïù¥ÌÑ∞ Ïä§ÌÇµ`);\n    return null;\n}\n\nif (fieldsData.length === 0) {\n    node.log(\"No valid data to write\");\n    return null;\n}\n\nconst lineProtocol = `kocData,${tagsData} ${fieldsData.join(\",\")} ${tsNs}`;\n\nmsg.payload = lineProtocol;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 480,
        "y": 120,
        "wires": [
            [
                "bb2ba36c1799197c",
                "338dd94832f90c92"
            ]
        ]
    },
    {
        "id": "bb2ba36c1799197c",
        "type": "http request",
        "z": "2ced808b3820b5c5",
        "name": "InfluxDB ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•",
        "method": "POST",
        "ret": "txt",
        "url": "http://influxdb2:8086/api/v2/write?org=KIST&bucket=KISTopenChamber&precision=ns",
        "headers": [
            {
                "keyType": "Authorization",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "valueType": "other",
                "valueValue": "text/plain; charset=utf-8"
            }
        ],
        "x": 710,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "3b981b0854099221",
        "type": "http in",
        "z": "2ced808b3820b5c5",
        "name": "GET /control",
        "url": "/control",
        "method": "get",
        "x": 270,
        "y": 500,
        "wires": [
            [
                "13a1746ab885970b"
            ]
        ]
    },
    {
        "id": "13a1746ab885970b",
        "type": "function",
        "z": "2ced808b3820b5c5",
        "name": "ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Ï≤òÎ¶¨ (Í∞úÏÑ†)",
        "func": "if (!msg.req || !msg.res) {\n    node.error(\"HTTP request/response Í∞ùÏ≤¥Í∞Ä ÏóÜÏäµÎãàÎã§\");\n    return null;\n}\n\nconst q = (msg.req && msg.req.query) || {};\nconst controlType = String(q.controlType || '').trim();\n\nconst ALLOWED = ['exhaust_fan', 'air_damper', 'temperature_set', 'led_drive'];\nif (!ALLOWED.includes(controlType)) {\n    msg.statusCode = 400;\n    msg.payload = { ok: false, error: 'ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Ï†úÏñ¥ ÌÉÄÏûÖ: ' + controlType };\n    return [null, msg];\n}\n\nlet chamber = String(q.chamber_id || 'chamber_001').trim();\nif (!/^chamber_\\d{3}$/.test(chamber)) {\n    msg.statusCode = 400;\n    msg.payload = { ok: false, error: 'invalid chamber_id' };\n    return [null, msg];\n}\n\nnode.log('=== ' + controlType + ' ÏÑ§Ï†ï Ï≤òÎ¶¨: ' + chamber + ' ===');\nnode.log('Î∞õÏùÄ ÌååÎùºÎØ∏ÌÑ∞: ' + JSON.stringify(q));\n\n// InfluxDB Ï†ÄÏû•Ïö© Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ\nconst tags = [\n    'org_id=KIST',\n    'site_id=site_001',\n    'collector_id=edgeKIST_001',\n    'chamber_id=' + chamber,\n    'control_type=' + controlType\n].join(',');\n\nconst F = [];\nconst mode = q.mode ? String(q.mode).toLowerCase() : undefined;\nconst onoffValue = q.onoffValue ? String(q.onoffValue).toUpperCase() : undefined;\n\nif (mode) F.push('mode=\"' + mode + '\"');\n\n// Ï†úÏñ¥ Í¥ÄÎ†® Î©îÏãúÏßÄÎì§ Ï¥àÍ∏∞Ìôî\nlet timerManagerMsg = null;\nlet mqttManualMsg = null;\nlet ledStatusMsg = null;\n\n// ÏàòÎèô Ï†úÏñ¥ Ï≤òÎ¶¨\nif (mode === 'manual' && onoffValue && \n    (controlType === 'led_drive' || controlType === 'exhaust_fan' || controlType === 'air_damper')) {\n    F.push('onoffValue=\"' + onoffValue + '\"');\n    \n    // ÏûêÎèô Ï†úÏñ¥ Ï§ëÏßÄ\n    timerManagerMsg = {\n        action: 'stop_auto_control',\n        chamber_id: chamber,\n        controlType: controlType\n    };\n    \n    // MQTT ÏàòÎèô Ï†úÏñ¥ Î©îÏãúÏßÄ\n    mqttManualMsg = {\n        topic: `kist/control/site_001/${chamber}/edgeKIST_001/${controlType}`,\n        payload: JSON.stringify({\n            type: `control_${controlType}`,\n            controlType: controlType,\n            mode: \"manual\",\n            onoffValue: onoffValue,\n            chamber_id: chamber,\n            ts: new Date().toISOString(),\n            source: \"manual_button\"\n        })\n    };\n    \n    // LED ÏàòÎèô Ï†úÏñ¥ Ïãú ÏÉÅÌÉú Ï†ÄÏû•\n    if (controlType === 'led_drive') {\n        const statusValue = (onoffValue === 'ON') ? 1 : 0;\n        const now = new Date();\n        const utcTimestamp = now.toISOString();\n        const tsMs = Date.parse(utcTimestamp);\n        const tsNs = (BigInt(tsMs) * 1000000n).toString();\n        \n        ledStatusMsg = {\n            payload: `kocControl,org_id=KIST,site_id=site_001,chamber_id=${chamber},collector_id=edgeKIST_001,control_type=led_drive led_actual_status=${statusValue} ${tsNs}`\n        };\n        \n        node.log(`LED ÏàòÎèô ÏÉÅÌÉú Ï†ÄÏû•: ${chamber} ${onoffValue} (${statusValue})`);\n    }\n    \n    node.log(`${controlType} ÏàòÎèô Ï†úÏñ¥: ${onoffValue}`);\n}\n\n// ÏûêÎèô Î™®Îìú Ï≤òÎ¶¨\nif (mode === 'auto' && (controlType === 'led_drive' || controlType === 'air_damper')) {\n    const avgTime = q.avgTime ? parseInt(q.avgTime, 10) : (controlType === 'led_drive' ? 15 : 10);\n    const setPoint = q.setPoint ? Number(q.setPoint) : (controlType === 'led_drive' ? 300 : 25);\n    \n    if (Number.isFinite(avgTime) && Number.isFinite(setPoint)) {\n        F.push('setPoint=' + setPoint);\n        F.push('avgTime=' + avgTime + 'i');\n        \n        timerManagerMsg = {\n            action: 'start_auto_control',\n            chamber_id: chamber,\n            controlType: controlType,\n            config: {\n                avgTime: avgTime,\n                setPoint: setPoint,\n                sensorField: controlType === 'led_drive' ? 'pyrRaw' : 'tRaw'\n            }\n        };\n        \n        node.log(`${controlType} ÏûêÎèôÎ™®Îìú: ${avgTime}Î∂Ñ, Í∏∞Ï§Ä ${setPoint}${controlType === 'led_drive' ? ' W/m¬≤' : '¬∞C'}`);\n    }\n}\n\n// Ïò®ÎèÑ ÏÑ§Ï†ï Ï≤òÎ¶¨\nif (controlType === 'temperature_set') {\n    if (q.tempSetPoint !== undefined) {\n        const val = Number(q.tempSetPoint);\n        if (Number.isFinite(val)) F.push('tempSetPoint=' + val);\n    }\n    if (q.temp_avg_time !== undefined) {\n        const val = parseInt(q.temp_avg_time, 10);\n        if (Number.isFinite(val)) F.push('temp_avg_time=' + val + 'i');\n    }\n}\n\nF.push('control_source=\"web_ui\"');\nF.push('control_timestamp=' + Date.now() + 'i');\n\nif (!F.length) {\n    msg.statusCode = 400;\n    msg.payload = { ok: false, error: 'no fields' };\n    return [null, msg];\n}\n\n// UTC ÏãúÍ∞ÑÏúºÎ°ú ÌÜµÏùº\nconst now = new Date();\nconst utcTimestamp = now.toISOString();\nconst tsMs = Date.parse(utcTimestamp);\nconst tsNs = (BigInt(tsMs) * 1000000n).toString();\n\nconst influxMsg = {\n    payload: 'kocControl,' + tags + ' ' + F.join(',') + ' ' + tsNs,\n    req: msg.req,\n    res: msg.res\n};\n\nnode.log('Ï†ÄÏû• ÏãúÍ∞Å: ' + utcTimestamp);\nnode.log('Ï†ÄÏû•: ' + influxMsg.payload);\n\n// Ï∂úÎ†•: [ÏÑ§Ï†ïÏ†ÄÏû•, HTTPÏùëÎãµ, ÌÉÄÏù¥Î®∏Í¥ÄÎ¶¨, MQTTÏ†úÏñ¥, LEDÏÉÅÌÉúÏ†ÄÏû•]\nreturn [influxMsg, null, timerManagerMsg, mqttManualMsg, ledStatusMsg];",
        "outputs": 5,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 500,
        "wires": [
            [
                "97581f5f75dfe28a",
                "3e61da5d53ff514f"
            ],
            [
                "b67cf7725efe68f1"
            ],
            [
                "57e425202fe4b45c",
                "0d518871052de13c"
            ],
            [
                "12800983df7804ed",
                "38751bbf49bede67"
            ],
            [
                "a22762f30117f77b",
                "310be298f7407c1e"
            ]
        ]
    },
    {
        "id": "97581f5f75dfe28a",
        "type": "http request",
        "z": "2ced808b3820b5c5",
        "name": "InfluxDB ÏÑ§Ï†ï Ï†ÄÏû•",
        "method": "POST",
        "ret": "txt",
        "url": "http://influxdb2:8086/api/v2/write?org=KIST&bucket=KISTopenChamber&precision=ns",
        "headers": [
            {
                "keyType": "Authorization",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "valueType": "other",
                "valueValue": "text/plain; charset=utf-8"
            }
        ],
        "x": 730,
        "y": 320,
        "wires": [
            [
                "ea39d406a560c1ea",
                "d671b6b1579f69ce"
            ]
        ]
    },
    {
        "id": "ea39d406a560c1ea",
        "type": "function",
        "z": "2ced808b3820b5c5",
        "name": "HTTP 200 ÏùëÎãµ",
        "func": "if (!msg.req || !msg.res) {\n    node.error(\"HTTP request/response Í∞ùÏ≤¥Í∞Ä ÏóÜÏäµÎãàÎã§\");\n    return null;\n}\n\nmsg.statusCode = 200;\nmsg.headers = { \n    'Content-Type':'application/json; charset=utf-8', \n    'Access-Control-Allow-Origin':'*',\n    'Cache-Control': 'no-cache'\n};\nmsg.payload = { ok: true, message: 'ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§' };\nreturn msg;",
        "outputs": 1,
        "x": 940,
        "y": 320,
        "wires": [
            [
                "b67cf7725efe68f1"
            ]
        ]
    },
    {
        "id": "b67cf7725efe68f1",
        "type": "http response",
        "z": "2ced808b3820b5c5",
        "name": "HTTP ÏùëÎãµ",
        "x": 1130,
        "y": 300,
        "wires": []
    },
    {
        "id": "57e425202fe4b45c",
        "type": "function",
        "z": "2ced808b3820b5c5",
        "name": "ÌÜµÌï© ÌÉÄÏù¥Î®∏ Îß§ÎãàÏ†Ä",
        "func": "\n// ÌÜµÌï© ÌÉÄÏù¥Î®∏ Îß§ÎãàÏ†Ä ÌÅ¥ÎûòÏä§ Ï†ïÏùò\nfunction createTimerManager() {\n    return {\n        // ÏûêÎèô Ï†úÏñ¥ ÏãúÏûë\n        startAutoControl: function(chamber, controlType, config) {\n            // ÏßÄÏõêÎêòÏßÄ ÏïäÎäî Ï†úÏñ¥ ÌÉÄÏûÖ Ï≤¥ÌÅ¨\n            if (!['led_drive', 'air_damper'].includes(controlType)) {\n                node.log(`[${chamber}] ${controlType}Îäî ÏûêÎèô Ï†úÏñ¥Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§`);\n                return false;\n            }\n            \n            // Í∏∞Ï°¥ Ï†úÏñ¥ Ï§ëÏßÄ\n            this.stopAutoControl(chamber, controlType);\n            \n            // ÏÑ§Ï†ï Í≤ÄÏ¶ù\n            if (!this.validateConfig(config)) {\n                node.error(`Invalid config for ${chamber}:${controlType}`);\n                return false;\n            }\n            \n            const autoControl = global.get('autoControl') || {\n                led_drive: { timers: {}, states: {} },\n                air_damper: { timers: {}, states: {} }\n            };\n            \n            // ÏÉÅÌÉú Ï†ÄÏû•\n            autoControl[controlType].states[chamber] = {\n                ...config,\n                startedAt: new Date().toISOString(),\n                cycleNumber: 0,\n                isActive: true\n            };\n            \n            // Ï≤´ Ïã§Ìñâ Ïä§ÏºÄÏ§ÑÎßÅ\n            const delayMs = config.avgTime * 60 * 1000;\n            autoControl[controlType].timers[chamber] = setTimeout(() => {\n                this.executeControlCycle(chamber, controlType);\n            }, delayMs);\n            \n            global.set('autoControl', autoControl);\n            \n            node.log(`[${chamber}] ${controlType} ÏûêÎèôÏ†úÏñ¥ ÏãúÏûë: ${config.avgTime}Î∂Ñ/${config.setPoint}`);\n            return true;\n        },\n        \n        // ÏûêÎèô Ï†úÏñ¥ Ï§ëÏßÄ\n        stopAutoControl: function(chamber, controlType) {\n            // ÏßÄÏõêÎêòÏßÄ ÏïäÎäî Ï†úÏñ¥ ÌÉÄÏûÖÏùÄ Í±¥ÎÑàÎõ∞Í∏∞\n            if (!['led_drive', 'air_damper'].includes(controlType)) {\n                node.log(`[${chamber}] ${controlType}Îäî ÏûêÎèô Ï†úÏñ¥ ÎåÄÏÉÅÏù¥ ÏïÑÎãôÎãàÎã§`);\n                return;\n            }\n            \n            const autoControl = global.get('autoControl') || {\n                led_drive: { timers: {}, states: {} },\n                air_damper: { timers: {}, states: {} }\n            };\n            \n            if (autoControl[controlType] && autoControl[controlType].timers && autoControl[controlType].timers[chamber]) {\n                clearTimeout(autoControl[controlType].timers[chamber]);\n                delete autoControl[controlType].timers[chamber];\n                node.log(`[${chamber}] ${controlType} ÌÉÄÏù¥Î®∏ Ï§ëÏßÄ`);\n            }\n            \n            if (autoControl[controlType] && autoControl[controlType].states && autoControl[controlType].states[chamber]) {\n                autoControl[controlType].states[chamber].isActive = false;\n                delete autoControl[controlType].states[chamber];\n            }\n            \n            global.set('autoControl', autoControl);\n        },\n        \n        // Ï†úÏñ¥ ÏÇ¨Ïù¥ÌÅ¥ Ïã§Ìñâ\n        executeControlCycle: function(chamber, controlType) {\n            const autoControl = global.get('autoControl') || {\n                led_drive: { timers: {}, states: {} },\n                air_damper: { timers: {}, states: {} }\n            };\n            \n            if (!autoControl[controlType] || !autoControl[controlType].states) {\n                node.log(`[${chamber}] ${controlType} Ï†úÏñ¥ Í∞ùÏ≤¥Í∞Ä ÏóÜÏäµÎãàÎã§`);\n                return;\n            }\n            \n            const state = autoControl[controlType].states[chamber];\n            \n            if (!state || !state.isActive) {\n                node.log(`[${chamber}] ${controlType} ÏÉÅÌÉú ÏóÜÏùå ÎòêÎäî ÎπÑÌôúÏÑ±`);\n                return;\n            }\n            \n            state.cycleNumber = (state.cycleNumber || 0) + 1;\n            state.lastExecutedAt = new Date().toISOString();\n            \n            // Flux ÏøºÎ¶¨ ÏÉùÏÑ±\n            const fluxQuery = this.buildFluxQuery(chamber, state.sensorField);\n            \n            // ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Î©îÏãúÏßÄ ÏÉùÏÑ±\n            const queryMsg = {\n                payload: fluxQuery,\n                chamber_id: chamber,\n                controlType: controlType,\n                state: { ...state }\n            };\n            \n            global.set('autoControl', autoControl);\n            \n            // ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå ÎÖ∏ÎìúÎ°ú Ï†ÑÏÜ°\n            node.send(queryMsg);\n        },\n        \n        // ÏÑ§Ï†ï Í≤ÄÏ¶ù\n        validateConfig: function(config) {\n            return config && \n                   Number.isFinite(config.avgTime) && config.avgTime > 0 &&\n                   Number.isFinite(config.setPoint) &&\n                   typeof config.sensorField === 'string' && config.sensorField.length > 0;\n        },\n        \n        // Flux ÏøºÎ¶¨ ÏÉùÏÑ±\n        buildFluxQuery: function(chamber, sensorField) {\n            return `from(bucket: \"KISTopenChamber\")\n                |> range(start: -6h)\n                |> filter(fn: (r) => r._measurement == \"kocData\" and r.chamber_id == \"${chamber}\" and r._field == \"${sensorField}\")\n                |> mean()\n                |> keep(columns: [\"_value\"])`;\n        }\n    };\n}\n\n// ÌÉÄÏù¥Î®∏ Îß§ÎãàÏ†Ä Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±\nconst timerManager = createTimerManager();\n\nif (!msg.action) {\n    return null;\n}\n\nconst chamber = msg.chamber_id || 'chamber_001';\nconst controlType = msg.controlType || 'led_drive';\nconst action = msg.action;\n\nif (action === 'stop_auto_control') {\n    timerManager.stopAutoControl(chamber, controlType);\n} else if (action === 'start_auto_control' && msg.config) {\n    timerManager.startAutoControl(chamber, controlType, msg.config);\n}\n\nreturn null;\n\n\n\n// // ÌÜµÌï© ÌÉÄÏù¥Î®∏ Îß§ÎãàÏ†Ä ÌÅ¥ÎûòÏä§ Ï†ïÏùò\n// function createTimerManager() {\n//     return {\n//         // ÏûêÎèô Ï†úÏñ¥ ÏãúÏûë\n//         startAutoControl: function(chamber, controlType, config) {\n//             // Í∏∞Ï°¥ Ï†úÏñ¥ Ï§ëÏßÄ\n//             this.stopAutoControl(chamber, controlType);\n            \n//             // ÏÑ§Ï†ï Í≤ÄÏ¶ù\n//             if (!this.validateConfig(config)) {\n//                 node.error(`Invalid config for ${chamber}:${controlType}`);\n//                 return false;\n//             }\n            \n//             const autoControl = global.get('autoControl') || {\n//                 led_drive: { timers: {}, states: {} },\n//                 air_damper: { timers: {}, states: {} }\n//             };\n            \n//             // ÏÉÅÌÉú Ï†ÄÏû•\n//             autoControl[controlType].states[chamber] = {\n//                 ...config,\n//                 startedAt: new Date().toISOString(),\n//                 cycleNumber: 0,\n//                 isActive: true\n//             };\n            \n//             // Ï≤´ Ïã§Ìñâ Ïä§ÏºÄÏ§ÑÎßÅ\n//             const delayMs = config.avgTime * 60 * 1000;\n//             autoControl[controlType].timers[chamber] = setTimeout(() => {\n//                 this.executeControlCycle(chamber, controlType);\n//             }, delayMs);\n            \n//             global.set('autoControl', autoControl);\n            \n//             node.log(`[${chamber}] ${controlType} ÏûêÎèôÏ†úÏñ¥ ÏãúÏûë: ${config.avgTime}Î∂Ñ/${config.setPoint}`);\n//             return true;\n//         },\n        \n//         // ÏûêÎèô Ï†úÏñ¥ Ï§ëÏßÄ\n//         stopAutoControl: function(chamber, controlType) {\n//             const autoControl = global.get('autoControl') || {\n//                 led_drive: { timers: {}, states: {} },\n//                 air_damper: { timers: {}, states: {} }\n//             };\n            \n//             if (autoControl[controlType].timers[chamber]) {\n//                 clearTimeout(autoControl[controlType].timers[chamber]);\n//                 delete autoControl[controlType].timers[chamber];\n//                 node.log(`[${chamber}] ${controlType} ÌÉÄÏù¥Î®∏ Ï§ëÏßÄ`);\n//             }\n            \n//             if (autoControl[controlType].states[chamber]) {\n//                 autoControl[controlType].states[chamber].isActive = false;\n//                 delete autoControl[controlType].states[chamber];\n//             }\n            \n//             global.set('autoControl', autoControl);\n//         },\n        \n//         // Ï†úÏñ¥ ÏÇ¨Ïù¥ÌÅ¥ Ïã§Ìñâ\n//         executeControlCycle: function(chamber, controlType) {\n//             const autoControl = global.get('autoControl') || {\n//                 led_drive: { timers: {}, states: {} },\n//                 air_damper: { timers: {}, states: {} }\n//             };\n            \n//             const state = autoControl[controlType].states[chamber];\n            \n//             if (!state || !state.isActive) {\n//                 node.log(`[${chamber}] ${controlType} ÏÉÅÌÉú ÏóÜÏùå ÎòêÎäî ÎπÑÌôúÏÑ±`);\n//                 return;\n//             }\n            \n//             state.cycleNumber = (state.cycleNumber || 0) + 1;\n//             state.lastExecutedAt = new Date().toISOString();\n            \n//             // Flux ÏøºÎ¶¨ ÏÉùÏÑ±\n//             const fluxQuery = this.buildFluxQuery(chamber, state.sensorField);\n            \n//             // ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Î©îÏãúÏßÄ ÏÉùÏÑ±\n//             const queryMsg = {\n//                 payload: fluxQuery,\n//                 chamber_id: chamber,\n//                 controlType: controlType,\n//                 state: { ...state }\n//             };\n            \n//             global.set('autoControl', autoControl);\n            \n//             // ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå ÎÖ∏ÎìúÎ°ú Ï†ÑÏÜ°\n//             node.send(queryMsg);\n//         },\n        \n//         // ÏÑ§Ï†ï Í≤ÄÏ¶ù\n//         validateConfig: function(config) {\n//             return config && \n//                    Number.isFinite(config.avgTime) && config.avgTime > 0 &&\n//                    Number.isFinite(config.setPoint) &&\n//                    typeof config.sensorField === 'string' && config.sensorField.length > 0;\n//         },\n        \n//         // Flux ÏøºÎ¶¨ ÏÉùÏÑ±\n//         buildFluxQuery: function(chamber, sensorField) {\n//             return `from(bucket: \"KISTopenChamber\")\n//                 |> range(start: -6h)\n//                 |> filter(fn: (r) => r._measurement == \"kocData\" and r.chamber_id == \"${chamber}\" and r._field == \"${sensorField}\")\n//                 |> mean()\n//                 |> keep(columns: [\"_value\"])`;\n//         }\n//     };\n// }\n\n// // ÌÉÄÏù¥Î®∏ Îß§ÎãàÏ†Ä Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±\n// const timerManager = createTimerManager();\n\n// if (!msg.action) {\n//     return null;\n// }\n\n// const chamber = msg.chamber_id || 'chamber_001';\n// const controlType = msg.controlType || 'led_drive';\n// const action = msg.action;\n\n// if (action === 'stop_auto_control') {\n//     timerManager.stopAutoControl(chamber, controlType);\n// } else if (action === 'start_auto_control' && msg.config) {\n//     timerManager.startAutoControl(chamber, controlType, msg.config);\n// }\n\n// return null;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 560,
        "wires": [
            [
                "33343f2a69cc8bfe",
                "309f49f5e3bac2c7"
            ]
        ]
    },
    {
        "id": "33343f2a69cc8bfe",
        "type": "http request",
        "z": "2ced808b3820b5c5",
        "name": "InfluxDB ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå",
        "method": "POST",
        "ret": "txt",
        "url": "http://influxdb2:8086/api/v2/query?org=KIST",
        "headers": [
            {
                "keyType": "Authorization",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "valueType": "other",
                "valueValue": "application/vnd.flux"
            },
            {
                "keyType": "Accept",
                "valueType": "other",
                "valueValue": "application/csv"
            }
        ],
        "x": 990,
        "y": 560,
        "wires": [
            [
                "49c07b823c1a6514",
                "cbacafdaa07f739d"
            ]
        ]
    },
    {
        "id": "49c07b823c1a6514",
        "type": "function",
        "z": "2ced808b3820b5c5",
        "name": "Ï†úÏñ¥ ÌåêÎã® Î∞è Ïä§ÏºÄÏ§ÑÎü¨",
        "func": "// ÌÉÄÏù¥Î®∏ Îß§ÎãàÏ†Ä ÌÅ¥ÎûòÏä§ Ï†ïÏùò (ÎèôÏùºÌïú Íµ¨Ï°∞ Ïú†ÏßÄ)\nfunction createTimerManager() {\n    return {\n        // Ï†úÏñ¥ ÌåêÎã® Î∞è Îã§Ïùå ÏÇ¨Ïù¥ÌÅ¥ Ïä§ÏºÄÏ§ÑÎßÅ\n        processControlDecision: function(chamber, controlType, avgValue, state) {\n            if (!state || !state.isActive) return [null, null];\n            \n            const decision = this.makeControlDecision(controlType, avgValue, state.setPoint);\n            \n            if (decision.shouldControl) {\n                // MQTT Î©îÏãúÏßÄ ÏÉùÏÑ±\n                const mqttMsg = this.createMqttMessage(chamber, controlType, decision, state);\n                \n                // LED ÏÉÅÌÉú Ï†ÄÏû• Î©îÏãúÏßÄ ÏÉùÏÑ± (LEDÏù∏ Í≤ΩÏö∞)\n                const statusMsg = controlType === 'led_drive' ? \n                    this.createStatusMessage(chamber, decision.onoffValue) : null;\n                \n                // Îã§Ïùå ÏÇ¨Ïù¥ÌÅ¥ Ïä§ÏºÄÏ§ÑÎßÅ\n                this.scheduleNextCycle(chamber, controlType, state);\n                \n                return [mqttMsg, statusMsg];\n            } else {\n                // Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå - Ïû¨ÏãúÎèÑ Ïä§ÏºÄÏ§ÑÎßÅ\n                this.scheduleRetry(chamber, controlType, state);\n                return [null, null];\n            }\n        },\n        \n        // Ï†úÏñ¥ ÌåêÎã® Î°úÏßÅ\n        makeControlDecision: function(controlType, avgValue, setPoint) {\n            if (!Number.isFinite(avgValue)) {\n                return { shouldControl: false, reason: 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå' };\n            }\n            \n            let onoffValue, reason;\n            \n            if (controlType === 'led_drive') {\n                onoffValue = avgValue < setPoint ? 'ON' : 'OFF';\n                reason = `ÌèâÍ∑† ${avgValue.toFixed(1)}W/m¬≤ ${avgValue < setPoint ? '<' : '>='} Í∏∞Ï§Ä ${setPoint}W/m¬≤`;\n            } else {\n                onoffValue = avgValue >= setPoint ? 'ON' : 'OFF';\n                reason = `ÌèâÍ∑† ${avgValue.toFixed(1)}¬∞C ${avgValue >= setPoint ? '>=' : '<'} Í∏∞Ï§Ä ${setPoint}¬∞C`;\n            }\n            \n            return { shouldControl: true, onoffValue, reason };\n        },\n        \n        // Îã§Ïùå ÏÇ¨Ïù¥ÌÅ¥ Ïä§ÏºÄÏ§ÑÎßÅ\n        scheduleNextCycle: function(chamber, controlType, state) {\n            const autoControl = global.get('autoControl') || {\n                led_drive: { timers: {}, states: {} },\n                air_damper: { timers: {}, states: {} }\n            };\n            \n            // Í∏∞Ï°¥ ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨\n            if (autoControl[controlType].timers[chamber]) {\n                clearTimeout(autoControl[controlType].timers[chamber]);\n            }\n            \n            const delayMs = state.avgTime * 60 * 1000;\n            const nextTime = new Date(Date.now() + delayMs);\n            \n            autoControl[controlType].timers[chamber] = setTimeout(() => {\n                this.executeControlCycle(chamber, controlType);\n            }, delayMs);\n            \n            global.set('autoControl', autoControl);\n            \n            node.log(`[${chamber}] ${controlType} Îã§Ïùå Ïã§Ìñâ: ${nextTime.toLocaleTimeString()}`);\n        },\n        \n        // Ïû¨ÏãúÎèÑ Ïä§ÏºÄÏ§ÑÎßÅ (Îç∞Ïù¥ÌÑ∞ ÏóÜÏùÑ Îïå)\n        scheduleRetry: function(chamber, controlType, state) {\n            const retryDelayMs = 5 * 60 * 1000; // 5Î∂Ñ ÌõÑ Ïû¨ÏãúÎèÑ\n            \n            const autoControl = global.get('autoControl') || {\n                led_drive: { timers: {}, states: {} },\n                air_damper: { timers: {}, states: {} }\n            };\n            \n            if (autoControl[controlType].timers[chamber]) {\n                clearTimeout(autoControl[controlType].timers[chamber]);\n            }\n            \n            autoControl[controlType].timers[chamber] = setTimeout(() => {\n                this.executeControlCycle(chamber, controlType);\n            }, retryDelayMs);\n            \n            global.set('autoControl', autoControl);\n            \n            node.log(`[${chamber}] ${controlType} Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå - 5Î∂Ñ ÌõÑ Ïû¨ÏãúÎèÑ`);\n        },\n        \n        // Ï†úÏñ¥ ÏÇ¨Ïù¥ÌÅ¥ Ïã§Ìñâ (ÌÉÄÏù¥Î®∏ Îß§ÎãàÏ†ÄÏôÄ ÎèôÏùº)\n        executeControlCycle: function(chamber, controlType) {\n            const autoControl = global.get('autoControl') || {\n                led_drive: { timers: {}, states: {} },\n                air_damper: { timers: {}, states: {} }\n            };\n            \n            const state = autoControl[controlType].states[chamber];\n            \n            if (!state || !state.isActive) {\n                node.log(`[${chamber}] ${controlType} ÏÉÅÌÉú ÏóÜÏùå ÎòêÎäî ÎπÑÌôúÏÑ±`);\n                return;\n            }\n            \n            state.cycleNumber = (state.cycleNumber || 0) + 1;\n            state.lastExecutedAt = new Date().toISOString();\n            \n            // Flux ÏøºÎ¶¨ ÏÉùÏÑ±\n            const fluxQuery = this.buildFluxQuery(chamber, state.sensorField);\n            \n            // ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Î©îÏãúÏßÄ ÏÉùÏÑ±\n            const queryMsg = {\n                payload: fluxQuery,\n                chamber_id: chamber,\n                controlType: controlType,\n                state: { ...state }\n            };\n            \n            global.set('autoControl', autoControl);\n            \n            // Ïù¥Ï†Ñ ÎÖ∏ÎìúÎ°ú Îã§Ïãú Ï†ÑÏÜ°\n            node.send([null, null, queryMsg]);\n        },\n        \n        buildFluxQuery: function(chamber, sensorField) {\n            return `from(bucket: \"KISTopenChamber\")\n                |> range(start: -6h)\n                |> filter(fn: (r) => r._measurement == \"kocData\" and r.chamber_id == \"${chamber}\" and r._field == \"${sensorField}\")\n                |> mean()\n                |> keep(columns: [\"_value\"])`;\n        },\n        \n        // MQTT Î©îÏãúÏßÄ ÏÉùÏÑ±\n        createMqttMessage: function(chamber, controlType, decision, state) {\n            return {\n                topic: `kist/control/site_001/${chamber}/edgeKIST_001/${controlType}`,\n                payload: JSON.stringify({\n                    type: `control_${controlType}`,\n                    controlType: controlType,\n                    mode: \"auto\",\n                    onoffValue: decision.onoffValue,\n                    chamber_id: chamber,\n                    ts: new Date().toISOString(),\n                    reason: decision.reason,\n                    cycleNumber: state.cycleNumber\n                })\n            };\n        },\n        \n        // LED ÏÉÅÌÉú Î©îÏãúÏßÄ ÏÉùÏÑ±\n        createStatusMessage: function(chamber, onoffValue) {\n            const statusValue = (onoffValue === 'ON') ? 1 : 0;\n            const now = new Date();\n            const utcTimestamp = now.toISOString();\n            const tsMs = Date.parse(utcTimestamp);\n            const tsNs = (BigInt(tsMs) * 1000000n).toString();\n            \n            return {\n                payload: `kocControl,org_id=KIST,site_id=site_001,chamber_id=${chamber},collector_id=edgeKIST_001,control_type=led_drive led_actual_status=${statusValue} ${tsNs}`\n            };\n        }\n    };\n}\n\nconst timerManager = createTimerManager();\n\nconst chamber = msg.chamber_id || 'chamber_001';\nconst controlType = msg.controlType || 'led_drive';\nconst state = msg.state;\nconst csv = (msg.payload || '').trim();\n\n// CSVÏóêÏÑú ÌèâÍ∑†Í∞í Ï∂îÏ∂ú\nlet avgValue = NaN;\n\nif (csv && csv.length > 10) {\n    const lines = csv.split(/\\r?\\n/).filter(line => line.trim());\n    if (lines.length >= 2) {\n        const header = lines[0].split(',');\n        const dataLine = lines[1].split(',');\n        const valueIndex = header.indexOf('_value');\n        if (valueIndex >= 0 && dataLine[valueIndex]) {\n            avgValue = parseFloat(dataLine[valueIndex]);\n        }\n    }\n}\n\nnode.log(`[${chamber}] ${controlType} ÌèâÍ∑†Í∞í: ${Number.isFinite(avgValue) ? avgValue.toFixed(2) : 'N/A'}`);\n\n// Ï†úÏñ¥ ÌåêÎã® Î∞è Ïä§ÏºÄÏ§ÑÎßÅ\nconst [mqttMsg, statusMsg] = timerManager.processControlDecision(chamber, controlType, avgValue, state);\n\n// Ï∂úÎ†•: [MQTTÏ†úÏñ¥, LEDÏÉÅÌÉúÏ†ÄÏû•, Îã§ÏùåÏÇ¨Ïù¥ÌÅ¥ÏøºÎ¶¨]\nreturn [mqttMsg, statusMsg, null];",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 560,
        "wires": [
            [
                "12800983df7804ed",
                "e0de536b658e6b33"
            ],
            [
                "a22762f30117f77b",
                "b6140e7290e0ce2a"
            ],
            [
                "33343f2a69cc8bfe",
                "a10726e35d676ec0"
            ]
        ]
    },
    {
        "id": "12800983df7804ed",
        "type": "mqtt out",
        "z": "2ced808b3820b5c5",
        "name": "MQTT Ï†úÏñ¥",
        "topic": "",
        "broker": "fe5f57faf4c94451",
        "x": 1550,
        "y": 520,
        "wires": []
    },
    {
        "id": "a22762f30117f77b",
        "type": "http request",
        "z": "2ced808b3820b5c5",
        "name": "InfluxDB LED ÏÉÅÌÉú Ï†ÄÏû•",
        "method": "POST",
        "ret": "txt",
        "url": "http://influxdb2:8086/api/v2/write?org=KIST&bucket=KISTopenChamber&precision=ns",
        "headers": [
            {
                "keyType": "Authorization",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "valueType": "other",
                "valueValue": "text/plain; charset=utf-8"
            }
        ],
        "x": 1580,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "b9906c5a172b28b7",
        "type": "http in",
        "z": "2ced808b3820b5c5",
        "name": "GET /settings/latest",
        "url": "/settings/latest",
        "method": "get",
        "x": 290,
        "y": 280,
        "wires": [
            [
                "5e6b5729092049ef"
            ]
        ]
    },
    {
        "id": "5e6b5729092049ef",
        "type": "function",
        "z": "2ced808b3820b5c5",
        "name": "Î™®Îì† ÏÑ§Ï†ï Ï°∞Ìöå Flux",
        "func": "if (!msg.req || !msg.res) {\n    node.error(\"HTTP request/response Í∞ùÏ≤¥Í∞Ä ÏóÜÏäµÎãàÎã§\");\n    return null;\n}\n\nconst chamber = (msg.req && msg.req.query && msg.req.query.chamber_id) || 'chamber_001';\n\nmsg.payload = 'from(bucket: \"KISTopenChamber\")' +\n  '|> range(start: -7d)' +\n  '|> filter(fn: (r) => r._measurement == \"kocControl\")' +\n  '|> filter(fn: (r) => r.chamber_id == \"' + chamber + '\")' +\n  '|> tail(n: 50)';\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 280,
        "wires": [
            [
                "c86d058a58912de1",
                "0ee5e54f589d1f6f"
            ]
        ]
    },
    {
        "id": "c86d058a58912de1",
        "type": "http request",
        "z": "2ced808b3820b5c5",
        "name": "InfluxDB ÏÑ§Ï†ï Ï°∞Ìöå",
        "method": "POST",
        "ret": "txt",
        "url": "http://influxdb2:8086/api/v2/query?org=KIST",
        "headers": [
            {
                "keyType": "Authorization",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "valueType": "other",
                "valueValue": "application/vnd.flux"
            },
            {
                "keyType": "Accept",
                "valueType": "other",
                "valueValue": "application/csv"
            }
        ],
        "x": 730,
        "y": 280,
        "wires": [
            [
                "eb0b72896b9f16ad",
                "7ee9894da04786ce"
            ]
        ]
    },
    {
        "id": "eb0b72896b9f16ad",
        "type": "function",
        "z": "2ced808b3820b5c5",
        "name": "ÏÑ§Ï†ï ÌååÏã±",
        "func": "if (!msg.req || !msg.res) {\n    node.error(\"HTTP request/response Í∞ùÏ≤¥Í∞Ä ÏóÜÏäµÎãàÎã§\");\n    return null;\n}\n\nconst csv = String(msg.payload || '').trim();\nconst settings = {\n    led_drive: { control_type: 'led_drive', mode: 'manual', onoffValue: 'OFF', setPoint: 300, avgTime: 15 },\n    exhaust_fan: { control_type: 'exhaust_fan', mode: 'manual', onoffValue: 'OFF' },\n    air_damper: { control_type: 'air_damper', mode: 'manual', onoffValue: 'OFF', setPoint: 25, avgTime: 10 }\n};\n\nif (csv && csv.length > 50) {\n    const lines = csv.split('\\n').filter(line => line.trim());\n    \n    if (lines.length >= 2) {\n        const header = lines[0].split(',').map(s => s.trim());\n        \n        // Í∞Å Ï†úÏñ¥ ÌÉÄÏûÖÎ≥Ñ ÏµúÏã† Îç∞Ïù¥ÌÑ∞ ÏàòÏßë\n        const latestData = {};\n        \n        for (let i = 1; i < lines.length; i++) {\n            const data = lines[i].split(',');\n            const row = {};\n            \n            header.forEach((h, idx) => {\n                if (data[idx] !== undefined && data[idx] !== '') {\n                    row[h] = data[idx].replace(/\"/g, '');\n                }\n            });\n            \n            const controlType = row.control_type;\n            const field = row._field;\n            const value = row._value;\n            const time = row._time;\n            \n            if (controlType && field && value !== undefined) {\n                if (!latestData[controlType]) {\n                    latestData[controlType] = {};\n                }\n                \n                // ÏãúÍ∞ÑÎ≥ÑÎ°ú ÏµúÏã† Îç∞Ïù¥ÌÑ∞Îßå Ïú†ÏßÄ\n                if (!latestData[controlType][field] || time > latestData[controlType][field].time) {\n                    latestData[controlType][field] = { value, time };\n                }\n            }\n        }\n        \n        // LED ÏÑ§Ï†ï Î≥µÏõê\n        if (latestData.led_drive) {\n            const led = latestData.led_drive;\n            settings.led_drive = {\n                control_type: 'led_drive',\n                mode: led.mode ? led.mode.value : 'manual',\n                onoffValue: led.onoffValue ? led.onoffValue.value : 'OFF',\n                setPoint: led.setPoint ? Number(led.setPoint.value) : 300,\n                avgTime: led.avgTime ? Number(led.avgTime.value) : 15\n            };\n        }\n        \n        // Î∞∞Í∏∞Ìå¨ ÏÑ§Ï†ï Î≥µÏõê\n        if (latestData.exhaust_fan) {\n            const fan = latestData.exhaust_fan;\n            settings.exhaust_fan = {\n                control_type: 'exhaust_fan',\n                mode: fan.mode ? fan.mode.value : 'manual',\n                onoffValue: fan.onoffValue ? fan.onoffValue.value : 'OFF'\n            };\n        }\n        \n        // ÏóêÏñ¥ÎåêÌçº ÏÑ§Ï†ï Î≥µÏõê\n        if (latestData.air_damper) {\n            const damper = latestData.air_damper;\n            settings.air_damper = {\n                control_type: 'air_damper',\n                mode: damper.mode ? damper.mode.value : 'manual',\n                onoffValue: damper.onoffValue ? damper.onoffValue.value : 'OFF',\n                setPoint: damper.setPoint ? Number(damper.setPoint.value) : 25,\n                avgTime: damper.avgTime ? Number(damper.avgTime.value) : 10\n            };\n        }\n        \n        node.log(\"ÌååÏã±Îêú ÏµúÏ¢Ö ÏÑ§Ï†ï: \" + JSON.stringify(settings));\n    }\n}\n\nmsg.statusCode = 200;\nmsg.headers = { 'Content-Type': 'application/json; charset=utf-8', 'Access-Control-Allow-Origin': '*' };\nmsg.payload = { ok: true, settings };\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 940,
        "y": 280,
        "wires": [
            [
                "b67cf7725efe68f1"
            ]
        ]
    },
    {
        "id": "7b24304c7db3fa2c",
        "type": "inject",
        "z": "2ced808b3820b5c5",
        "name": "ÏûêÎèôÎ≥µÍµ¨",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "once": true,
        "onceDelay": "3",
        "payload": "start",
        "x": 270,
        "y": 760,
        "wires": [
            [
                "3dc265e888e17761"
            ]
        ]
    },
    {
        "id": "3dc265e888e17761",
        "type": "function",
        "z": "2ced808b3820b5c5",
        "name": "Î≥µÍµ¨ Flux",
        "func": "node.log('ÏûêÎèô Î≥µÍµ¨ ÏãúÏûë');\n\nmsg.payload = 'from(bucket: \"KISTopenChamber\")' +\n  '|> range(start: -7d)' +\n  '|> filter(fn: (r) => r._measurement == \"kocControl\" and (r.control_type == \"led_drive\" or r.control_type == \"air_damper\"))' +\n  '|> group(columns: [\"chamber_id\", \"control_type\", \"_field\"])' +\n  '|> sort(columns: [\"_time\"], desc: true)' +\n  '|> first()' +\n  '|> group(columns: [\"chamber_id\", \"control_type\"])' +\n  '|> pivot(rowKey: [\"chamber_id\", \"control_type\"], columnKey: [\"_field\"], valueColumn: \"_value\")';\n\nreturn msg;",
        "outputs": 1,
        "x": 450,
        "y": 760,
        "wires": [
            [
                "a749e7f73bebd879"
            ]
        ]
    },
    {
        "id": "a749e7f73bebd879",
        "type": "http request",
        "z": "2ced808b3820b5c5",
        "name": "InfluxDB Î≥µÍµ¨ Ï°∞Ìöå",
        "method": "POST",
        "ret": "txt",
        "url": "http://influxdb2:8086/api/v2/query?org=KIST",
        "headers": [
            {
                "keyType": "Authorization",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "valueType": "other",
                "valueValue": "application/vnd.flux"
            },
            {
                "keyType": "Accept",
                "valueType": "other",
                "valueValue": "application/csv"
            }
        ],
        "x": 630,
        "y": 760,
        "wires": [
            [
                "af6ec97acbcc7807"
            ]
        ]
    },
    {
        "id": "af6ec97acbcc7807",
        "type": "function",
        "z": "2ced808b3820b5c5",
        "name": "Î≥µÍµ¨ ÌååÏã± Î∞è Ïã§Ìñâ",
        "func": "const csv = (msg.payload || '').trim();\n\nif (!csv || csv.length < 50) return null;\n\nconst lines = csv.split(/\\r?\\n/).filter(line => line.trim());\nif (lines.length < 2) return null;\n\nconst header = lines[0].split(',').map(s => s.trim());\nconst recoveryMsgs = [];\n\nfor (let i = 1; i < lines.length; i++) {\n    const data = lines[i].split(',');\n    const row = {};\n    \n    header.forEach((h, idx) => {\n        if (data[idx] !== undefined && data[idx] !== '') row[h] = data[idx];\n    });\n    \n    if (!row.chamber_id || row.mode !== 'auto') continue;\n    \n    const avgTime = row.avgTime ? parseInt(row.avgTime, 10) : (row.control_type === 'led_drive' ? 15 : 10);\n    const setPoint = row.setPoint ? parseFloat(row.setPoint) : (row.control_type === 'led_drive' ? 300 : 25);\n    \n    if (!Number.isFinite(avgTime) || !Number.isFinite(setPoint)) continue;\n    \n    recoveryMsgs.push({\n        action: 'start_auto_control',\n        chamber_id: row.chamber_id,\n        controlType: row.control_type,\n        config: {\n            avgTime: avgTime,\n            setPoint: setPoint,\n            sensorField: row.control_type === 'led_drive' ? 'pyrRaw' : 'tRaw'\n        }\n    });\n    \n    node.log(`Î≥µÍµ¨: [${row.chamber_id}] ${row.control_type} ${avgTime}Î∂Ñ/${setPoint}`);\n}\n\nnode.log(`Î≥µÍµ¨ ÏôÑÎ£å: Ï¥ù ${recoveryMsgs.length}Í∞ú Ï†úÏñ¥`);\n\n// Í∞Å Î≥µÍµ¨ Î©îÏãúÏßÄÎ•º Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°\nfor (let msg of recoveryMsgs) {\n    node.send(msg);\n}\n\nreturn null;",
        "outputs": 1,
        "x": 840,
        "y": 760,
        "wires": [
            [
                "57e425202fe4b45c"
            ]
        ]
    },
    {
        "id": "97ba2fa02214f659",
        "type": "http in",
        "z": "2ced808b3820b5c5",
        "name": "POST /save-ui-setting",
        "url": "/save-ui-setting",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 290,
        "y": 900,
        "wires": [
            [
                "5ce08d709e112a87"
            ]
        ]
    },
    {
        "id": "5ce08d709e112a87",
        "type": "function",
        "z": "2ced808b3820b5c5",
        "name": "UI ÏÑ§Ï†ï Ï†ÄÏû•",
        "func": "if (!msg.req || !msg.res) {\n    node.error(\"HTTP request/response Í∞ùÏ≤¥Í∞Ä ÏóÜÏäµÎãàÎã§\");\n    return null;\n}\n\n// Î∞õÏùÄ line protocol Îç∞Ïù¥ÌÑ∞Î•º Í∑∏ÎåÄÎ°ú Ï†ÑÎã¨\nconst lineProtocol = String(msg.payload || '').trim();\n\nif (!lineProtocol || lineProtocol.length < 10) {\n    msg.statusCode = 400;\n    msg.payload = { ok: false, error: 'Invalid data' };\n    return [null, msg];\n}\n\nnode.log('UI ÏÑ§Ï†ï Ï†ÄÏû•: ' + lineProtocol);\n\nconst influxMsg = {\n    payload: lineProtocol,\n    req: msg.req,\n    res: msg.res\n};\n\nreturn [influxMsg, null];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 900,
        "wires": [
            [
                "ba728b243b441733",
                "05bdfb03c3c37362"
            ],
            [
                "6aad68e4bc3fba59",
                "a735cb6b5dd1dd95"
            ]
        ]
    },
    {
        "id": "ba728b243b441733",
        "type": "http request",
        "z": "2ced808b3820b5c5",
        "name": "InfluxDB UI ÏÑ§Ï†ï Ï†ÄÏû•",
        "method": "POST",
        "ret": "txt",
        "url": "http://influxdb2:8086/api/v2/write?org=KIST&bucket=KISTopenChamber&precision=ns",
        "headers": [
            {
                "keyType": "Authorization",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "valueType": "other",
                "valueValue": "text/plain; charset=utf-8"
            }
        ],
        "x": 740,
        "y": 880,
        "wires": [
            [
                "0cd949e37f7206f1"
            ]
        ]
    },
    {
        "id": "0cd949e37f7206f1",
        "type": "function",
        "z": "2ced808b3820b5c5",
        "name": "ÏÑ±Í≥µ ÏùëÎãµ",
        "func": "if (!msg.req || !msg.res) {\n    node.error(\"HTTP request/response Í∞ùÏ≤¥Í∞Ä ÏóÜÏäµÎãàÎã§\");\n    return null;\n}\n\nmsg.statusCode = 200;\nmsg.headers = { \n    'Content-Type': 'application/json; charset=utf-8', \n    'Access-Control-Allow-Origin': '*'\n};\nmsg.payload = { ok: true, message: 'UI ÏÑ§Ï†ï Ï†ÄÏû•Îê®' };\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 960,
        "y": 880,
        "wires": [
            [
                "6aad68e4bc3fba59",
                "3bb8e9b5d9639b12"
            ]
        ]
    },
    {
        "id": "6aad68e4bc3fba59",
        "type": "http response",
        "z": "2ced808b3820b5c5",
        "name": "HTTP ÏùëÎãµ",
        "statusCode": "",
        "headers": {},
        "x": 1130,
        "y": 940,
        "wires": []
    },
    {
        "id": "b47feabf28a7fc1f",
        "type": "inject",
        "z": "2ced808b3820b5c5",
        "name": "ÌÉÄÏù¥Î®∏ Ìó¨Ïä§Ï≤¥ÌÅ¨",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "payload": "health_check",
        "x": 290,
        "y": 660,
        "wires": [
            [
                "5a28fc6c194b85e2"
            ]
        ]
    },
    {
        "id": "5a28fc6c194b85e2",
        "type": "function",
        "z": "2ced808b3820b5c5",
        "name": "ÌÉÄÏù¥Î®∏ ÏÉÅÌÉú Ï†êÍ≤Ä",
        "func": "const autoControl = global.get('autoControl') || {\n    led_drive: { timers: {}, states: {} },\n    air_damper: { timers: {}, states: {} }\n};\n\nlet issuesFound = 0;\n\n// LED ÌÉÄÏù¥Î®∏ ÏÉÅÌÉú Ï†êÍ≤Ä\nObject.keys(autoControl.led_drive.states).forEach(chamber => {\n    const state = autoControl.led_drive.states[chamber];\n    const timer = autoControl.led_drive.timers[chamber];\n    \n    if (state && state.isActive && !timer) {\n        node.warn(`[${chamber}] LED ÏÉÅÌÉúÎäî ÌôúÏÑ±Ïù¥ÏßÄÎßå ÌÉÄÏù¥Î®∏Í∞Ä ÏóÜÏùå - Î≥µÍµ¨ ÏãúÎèÑ`);\n        \n        // ÌÉÄÏù¥Î®∏ Î≥µÍµ¨\n        const delayMs = (state.avgTime || 15) * 60 * 1000;\n        autoControl.led_drive.timers[chamber] = setTimeout(() => {\n            // ÌÉÄÏù¥Î®∏ Îß§ÎãàÏ†ÄÏùò executeControlCycle Ìò∏Ï∂ú\n            node.send({\n                chamber_id: chamber,\n                controlType: 'led_drive',\n                state: state,\n                action: 'execute_cycle'\n            });\n        }, delayMs);\n        \n        issuesFound++;\n    }\n});\n\n// ÏóêÏñ¥ÎåêÌçº ÌÉÄÏù¥Î®∏ ÏÉÅÌÉú Ï†êÍ≤Ä\nObject.keys(autoControl.air_damper.states).forEach(chamber => {\n    const state = autoControl.air_damper.states[chamber];\n    const timer = autoControl.air_damper.timers[chamber];\n    \n    if (state && state.isActive && !timer) {\n        node.warn(`[${chamber}] ÏóêÏñ¥ÎåêÌçº ÏÉÅÌÉúÎäî ÌôúÏÑ±Ïù¥ÏßÄÎßå ÌÉÄÏù¥Î®∏Í∞Ä ÏóÜÏùå - Î≥µÍµ¨ ÏãúÎèÑ`);\n        \n        // ÌÉÄÏù¥Î®∏ Î≥µÍµ¨\n        const delayMs = (state.avgTime || 10) * 60 * 1000;\n        autoControl.air_damper.timers[chamber] = setTimeout(() => {\n            // ÌÉÄÏù¥Î®∏ Îß§ÎãàÏ†ÄÏùò executeControlCycle Ìò∏Ï∂ú\n            node.send({\n                chamber_id: chamber,\n                controlType: 'air_damper',\n                state: state,\n                action: 'execute_cycle'\n            });\n        }, delayMs);\n        \n        issuesFound++;\n    }\n});\n\nglobal.set('autoControl', autoControl);\n\nif (issuesFound > 0) {\n    node.log(`ÌÉÄÏù¥Î®∏ Ìó¨Ïä§Ï≤¥ÌÅ¨: ${issuesFound}Í∞ú Ïù¥Ïäà Î≥µÍµ¨Îê®`);\n} else {\n    node.log('ÌÉÄÏù¥Î®∏ Ìó¨Ïä§Ï≤¥ÌÅ¨: Î™®Îì† ÏÉÅÌÉú Ï†ïÏÉÅ');\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 480,
        "y": 660,
        "wires": [
            [
                "57e425202fe4b45c",
                "03dbd560d753531a"
            ]
        ]
    },
    {
        "id": "338dd94832f90c92",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 15",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 80,
        "wires": []
    },
    {
        "id": "04d485e51e861589",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 16",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 460,
        "y": 80,
        "wires": []
    },
    {
        "id": "e0de536b658e6b33",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 17",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1540,
        "y": 420,
        "wires": []
    },
    {
        "id": "b6140e7290e0ce2a",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 18",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1540,
        "y": 640,
        "wires": []
    },
    {
        "id": "309f49f5e3bac2c7",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 19",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 940,
        "y": 620,
        "wires": []
    },
    {
        "id": "a10726e35d676ec0",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 20",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1500,
        "y": 720,
        "wires": []
    },
    {
        "id": "0ee5e54f589d1f6f",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 21",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 220,
        "wires": []
    },
    {
        "id": "7ee9894da04786ce",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 22",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 940,
        "y": 240,
        "wires": []
    },
    {
        "id": "d671b6b1579f69ce",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 23",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 920,
        "y": 380,
        "wires": []
    },
    {
        "id": "cbacafdaa07f739d",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 24",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1220,
        "y": 620,
        "wires": []
    },
    {
        "id": "05bdfb03c3c37362",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 25",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 840,
        "wires": []
    },
    {
        "id": "a735cb6b5dd1dd95",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 26",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 940,
        "wires": []
    },
    {
        "id": "3bb8e9b5d9639b12",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 31",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1140,
        "y": 880,
        "wires": []
    },
    {
        "id": "3e61da5d53ff514f",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 32",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 400,
        "wires": []
    },
    {
        "id": "0d518871052de13c",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 33",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 800,
        "y": 480,
        "wires": []
    },
    {
        "id": "310be298f7407c1e",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 34",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 740,
        "y": 680,
        "wires": []
    },
    {
        "id": "38751bbf49bede67",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 35",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1100,
        "y": 460,
        "wires": []
    },
    {
        "id": "03dbd560d753531a",
        "type": "debug",
        "z": "2ced808b3820b5c5",
        "name": "debug 36",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 740,
        "y": 620,
        "wires": []
    },
    {
        "id": "5d833ce5ffc9a087",
        "type": "debug",
        "z": "7e65b47e49f97f97",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 780,
        "y": 300,
        "wires": []
    },
    {
        "id": "cadad03de8b8aa8c",
        "type": "debug",
        "z": "7e65b47e49f97f97",
        "name": "debug 4",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1060,
        "y": 300,
        "wires": []
    },
    {
        "id": "9ca58bb807f4b884",
        "type": "debug",
        "z": "7e65b47e49f97f97",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 600,
        "y": 300,
        "wires": []
    },
    {
        "id": "d55288139b43ebd9",
        "type": "mqtt in",
        "z": "7e65b47e49f97f97",
        "name": "ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ ÏàòÏã†",
        "topic": "kist/+/+/+/telemetry/minute",
        "qos": "0",
        "datatype": "json",
        "broker": "fe5f57faf4c94451",
        "inputs": 0,
        "x": 380,
        "y": 200,
        "wires": [
            [
                "7d50ed816677e428",
                "8c910b015b13860e"
            ]
        ]
    },
    {
        "id": "7d50ed816677e428",
        "type": "function",
        "z": "7e65b47e49f97f97",
        "name": "DLI ÎàÑÏ†Å Í≥ÑÏÇ∞",
        "func": "// pyrRaw Ï∂îÏ∂ú\nconst p = (typeof msg.payload === 'string') ? JSON.parse(msg.payload) : (msg.payload || {});\nconst m = /^kist\\/([^/]+)\\/([^/]+)\\/([^/]+)\\/telemetry\\/minute$/.exec(msg.topic || \"\");\n\nif (!m) return null;\n\nconst [_, site_id, chamber_id, collector_id] = m;\nconst pyrRaw = p.sensors?.pyrRaw;\n\nif (!Number.isFinite(pyrRaw) || pyrRaw < 0) return null;\n\n// PAR Î≥ÄÌôò (W/m¬≤ ‚Üí Œºmol/m¬≤/s)\n// Ï†ÑÏ≤¥ ÏùºÏÇ¨ÎüâÏùò ÏïΩ 45%Í∞Ä PAR ÏòÅÏó≠, Î≥ÄÌôòÍ≥ÑÏàò 4.57\nconst PAR = pyrRaw * 0.45 * 4.57;\n\n// ÌòÑÏû¨ ÎÇ†Ïßú (ÌïúÍµ≠ÏãúÍ∞Ñ)\nconst now = new Date();\nconst dateKey = now.toISOString().split('T')[0]; // YYYY-MM-DD\n\n// Ï±îÎ≤ÑÎ≥Ñ DLI ÎàÑÏ†ÅÍ∞í Ï†ÄÏû•ÏÜå\nconst dliData = global.get('dli_accumulation') || {};\nconst key = `${chamber_id}_${dateKey}`;\n\nif (!dliData[key]) {\n    dliData[key] = {\n        chamber_id: chamber_id,\n        date: dateKey,\n        accumulated_par: 0,\n        data_points: 0,\n        start_time: now.toISOString()\n    };\n}\n\n// 10Ï¥à Í∞ÑÍ≤© Ï∏°Ï†ïÏù¥ÎØÄÎ°ú 10Ï¥à * PAR ÎàÑÏ†Å\n// DLI = mol/m¬≤/day = (Œºmol/m¬≤/s √ó seconds) / 1,000,000\n// dliData[key].accumulated_par += PAR * 10;\ndliData[key].accumulated_par += PAR * 60;\ndliData[key].data_points += 1;\ndliData[key].last_update = now.toISOString();\n\nglobal.set('dli_accumulation', dliData);\n\nnode.log(`[${chamber_id}] ${dateKey} PARÎàÑÏ†Å: ${dliData[key].accumulated_par.toFixed(0)} Œºmol/m¬≤ (${dliData[key].data_points}Í∞ú Ìè¨Ïù∏Ìä∏)`);\n\nreturn null;",
        "outputs": 0,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 200,
        "wires": []
    },
    {
        "id": "94e98d16aaa0b265",
        "type": "inject",
        "z": "7e65b47e49f97f97",
        "name": "Îß§Ïùº 23:59 Ìä∏Î¶¨Í±∞",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "59 23 * * *",
        "once": false,
        "onceDelay": "",
        "topic": "",
        "payload": "calculate_dli",
        "payloadType": "str",
        "x": 390,
        "y": 340,
        "wires": [
            [
                "0c1c9c473d7ff9cd",
                "9ca58bb807f4b884"
            ]
        ]
    },
    {
        "id": "0c1c9c473d7ff9cd",
        "type": "function",
        "z": "7e65b47e49f97f97",
        "name": "DLI ÏµúÏ¢Ö Í≥ÑÏÇ∞",
        "func": "// =====================================================\n// 2. \"DLI ÏµúÏ¢Ö Í≥ÑÏÇ∞\" ÎÖ∏Îìú - UTCÎ°ú ÏàòÏ†ï\n// =====================================================\n\nconst dliData = global.get('dli_accumulation') || {};\n\n// UTC Í∏∞Ï§Ä Ïò§Îäò ÎÇ†Ïßú (ÌïúÍµ≠ÏãúÍ∞Ñ Î≥ÄÌôò Ï†úÍ±∞)\nconst now = new Date();\nconst dateKey = now.toISOString().split('T')[0]; // UTC ÎÇ†Ïßú ÏÇ¨Ïö©\n\nnode.log(`===== DLI ÏµúÏ¢Ö Í≥ÑÏÇ∞: ${dateKey} (UTC) =====`);\n\nconst results = [];\n\nfor (const key in dliData) {\n    if (key.endsWith(`_${dateKey}`)) {\n        const data = dliData[key];\n        \n        // DLI = accumulated_par / 1,000,000 (mol/m¬≤/day)\n        const dli = data.accumulated_par / 1000000;\n        \n        node.log(`[${data.chamber_id}] ${dateKey} DLI: ${dli.toFixed(2)} mol/m¬≤/day (${data.data_points}Í∞ú Ï∏°Ï†ï)`);\n        \n        results.push({\n            chamber_id: data.chamber_id,\n            date: data.date,\n            dli: dli,\n            data_points: data.data_points,\n            start_time: data.start_time,\n            end_time: data.last_update\n        });\n        \n        // Í≥ÑÏÇ∞ ÏôÑÎ£å ÌõÑ Ìï¥Îãπ ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú\n        delete dliData[key];\n    }\n}\n\nglobal.set('dli_accumulation', dliData);\n\nif (results.length === 0) {\n    node.log(`${dateKey} DLI Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå`);\n    node.log(`Ï†ÄÏû•ÏÜå ÌÇ§ Î™©Î°ù: ${Object.keys(dliData).join(', ')}`);\n    return null;\n}\n\nnode.log(`${results.length}Í∞ú Ï±îÎ≤Ñ DLI Í≥ÑÏÇ∞ ÏôÑÎ£å`);\n\nmsg.payload = results;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 340,
        "wires": [
            [
                "2fd09166c327acbc",
                "5d833ce5ffc9a087"
            ]
        ]
    },
    {
        "id": "2fd09166c327acbc",
        "type": "function",
        "z": "7e65b47e49f97f97",
        "name": "InfluxDB Line Protocol ÏÉùÏÑ±",
        "func": "// =====================================================\n// \"InfluxDB Line Protocol ÏÉùÏÑ±\" ÎÖ∏Îìú ÏàòÏ†ï\n// =====================================================\n\nconst results = msg.payload || [];\n\nif (!Array.isArray(results) || results.length === 0) return null;\n\nconst lines = [];\n\nfor (const r of results) {\n    // ÌïµÏã¨: ÌïúÍµ≠ÏãúÍ∞Ñ 23:59:59Î•º UTCÎ°ú Ï†ÄÏû•ÌïòÎêò, \n    // GrafanaÍ∞Ä Ïò¨Î∞îÎ•∏ ÎÇ†ÏßúÎ°ú Ïù∏ÏãùÌïòÎèÑÎ°ù ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï°∞Ï†ï\n    \n    // Î∞©Î≤ï: Ìï¥Îãπ ÎÇ†ÏßúÏùò UTC 12:00:00Ïóê Ï†ÄÏû•\n    // Ïù¥Î†áÍ≤å ÌïòÎ©¥ Ïñ¥Îñ§ ÏãúÍ∞ÑÎåÄÏóêÏÑúÎèÑ Í∞ôÏùÄ ÎÇ†ÏßúÎ°ú ÌëúÏãúÎê®\n    const timestamp = new Date(r.date + 'T12:00:00.000Z').getTime();\n    const tsNs = (BigInt(timestamp) * 1000000n).toString();\n\n    node.log(`${r.chamber_id} ${r.date} DLI: ${r.dli.toFixed(4)} mol/m¬≤/day`);\n    node.log(`Ï†ÄÏû• ÏãúÍ∞Ñ: ${new Date(timestamp).toISOString()} (UTC Ï†ïÏò§)`);\n\n    const tags = [\n        `org_id=KIST`,\n        `site_id=site_001`,\n        `chamber_id=${r.chamber_id}`\n    ].join(',');\n\n    const fields = [\n        `dli=${r.dli.toFixed(6)}`,\n        `data_points=${r.data_points}i`\n    ].join(',');\n\n    lines.push(`kocDLI,${tags} ${fields} ${tsNs}`);\n}\n\nmsg.payload = lines.join('\\n');\nnode.log(`DLI ${results.length}Í∞ú Ï±îÎ≤Ñ Ï†ÄÏû• Ï§ÄÎπÑ`);\n\nreturn msg;\n\n// const results = msg.payload || [];\n\n// if (!Array.isArray(results) || results.length === 0) return null;\n\n// const lines = [];\n\n// for (const r of results) {\n//     // ÌòÑÏû¨ ÏãúÍ∞Ñ ÏÇ¨Ïö© (ÎØ∏Îûò ÏãúÍ∞Ñ Î¨∏Ï†ú Ìï¥Í≤∞)\n//     const now = new Date();\n//     const timestamp = now.getTime();\n//     const tsNs = (BigInt(timestamp) * 1000000n).toString();\n\n//     node.log(`${r.chamber_id} DLI: ${r.dli.toFixed(4)} mol/m¬≤/day (${r.data_points}Í∞ú Ï∏°Ï†ï)`);\n//     node.log(`Ï†ÄÏû• ÏãúÍ∞Ñ: ${new Date(timestamp).toISOString()}`);\n\n//     const tags = [\n//         `org_id=KIST`,\n//         `site_id=site_001`,\n//         `chamber_id=${r.chamber_id}`\n//     ].join(',');\n\n//     const fields = [\n//         `dli=${r.dli.toFixed(6)}`,\n//         `data_points=${r.data_points}i`\n//     ].join(',');\n\n//     lines.push(`kocDLI,${tags} ${fields} ${tsNs}`);\n// }\n\n// msg.payload = lines.join('\\n');\n// node.log(`DLI ${results.length}Í∞ú Ï±îÎ≤Ñ Ï†ÄÏû• Ï§ÄÎπÑ`);\n\n// return msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 840,
        "y": 340,
        "wires": [
            [
                "091adaa414912b54",
                "cadad03de8b8aa8c"
            ]
        ]
    },
    {
        "id": "091adaa414912b54",
        "type": "http request",
        "z": "7e65b47e49f97f97",
        "name": "InfluxDB DLI Ï†ÄÏû•",
        "method": "POST",
        "ret": "txt",
        "url": "http://influxdb2:8086/api/v2/write?org=KIST&bucket=KISTopenChamber&precision=ns",
        "headers": [
            {
                "keyType": "Authorization",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "valueType": "other",
                "valueValue": "text/plain; charset=utf-8"
            }
        ],
        "x": 1090,
        "y": 340,
        "wires": [
            [
                "b1706864b938c1c3"
            ]
        ]
    },
    {
        "id": "28a89bf73713079f",
        "type": "inject",
        "z": "7e65b47e49f97f97",
        "name": "ÏàòÎèô DLI Í≥ÑÏÇ∞",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "once": false,
        "payload": "calculate_dli",
        "x": 370,
        "y": 380,
        "wires": [
            [
                "0c1c9c473d7ff9cd"
            ]
        ]
    },
    {
        "id": "8c910b015b13860e",
        "type": "debug",
        "z": "7e65b47e49f97f97",
        "name": "debug 2",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 600,
        "y": 160,
        "wires": []
    },
    {
        "id": "b1706864b938c1c3",
        "type": "debug",
        "z": "7e65b47e49f97f97",
        "name": "debug 5",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1280,
        "y": 340,
        "wires": []
    },
    {
        "id": "1ba225e3825d71a3",
        "type": "comment",
        "z": "7e65b47e49f97f97",
        "name": "Debug",
        "info": "",
        "x": 210,
        "y": 660,
        "wires": []
    },
    {
        "id": "4759087b5a292106",
        "type": "inject",
        "z": "7e65b47e49f97f97",
        "name": "Ïã§ÏãúÍ∞Ñ DLI ÏóÖÎç∞Ïù¥Ìä∏",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": false,
        "onceDelay": "",
        "topic": "",
        "payload": "realtime_update",
        "payloadType": "str",
        "x": 400,
        "y": 480,
        "wires": [
            [
                "811ee743d65df9bc"
            ]
        ]
    },
    {
        "id": "811ee743d65df9bc",
        "type": "function",
        "z": "7e65b47e49f97f97",
        "name": "Í≥†Ï†ïÌÇ§ Ïã§ÏãúÍ∞Ñ DLI",
        "func": "const dliData = global.get('dli_accumulation') || {};\n\nconst now = new Date();\nconst today = now.toISOString().split('T')[0];\n\n// ÌòÑÏû¨ ÏãúÍ∞Ñ ÏÇ¨Ïö© (Í∞ÄÏû• Ï§ëÏöî!)\nconst currentTime = now.getTime();\nconst currentTsNs = (BigInt(currentTime) * 1000000n).toString();\n\nconst lines = [];\n// const chambers = ['chamber_001', 'chamber_002', 'chamber_003', 'chamber_004', 'chamber_005'];\nconst chambers = ['chamber_001', 'chamber_002', 'chamber_003', 'chamber_004'];\n\n// ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏\nnode.log(`ÌòÑÏû¨ ÏãúÍ∞Ñ: ${now.toISOString()}`);\nnode.log(`ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ(ms): ${currentTime}`);\nnode.log(`ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ(ns): ${currentTsNs}`);\n\n// ÌïòÎ£® ÏßÑÌñâÎ•† Í≥ÑÏÇ∞\nconst dayStart = new Date(today + 'T00:00:00.000Z').getTime();\nconst dayProgress = ((now.getTime() - dayStart) / (24 * 60 * 60 * 1000) * 100);\nconst progressPercent = Math.min(dayProgress, 100).toFixed(1);\n\nchambers.forEach(chamberId => {\n    const key = `${chamberId}_${today}`;\n    const data = dliData[key];\n    \n    if (data) {\n        const currentDLI = (data.accumulated_par / 1000000).toFixed(6);\n        \n        const tags = [\n            `org_id=KIST`,\n            `site_id=site_001`,\n            `chamber_id=${chamberId}`,\n            `type=realtime`\n        ].join(',');\n        \n        const fields = [\n            `current_dli=${currentDLI}`,\n            `data_points=${data.data_points}i`,\n            `progress_percent=${progressPercent}`\n        ].join(',');\n        \n        lines.push(`kocLiveDLI,${tags} ${fields} ${currentTsNs}`);\n        \n        node.log(`[${chamberId}] DLI: ${currentDLI} mol/m¬≤/day`);\n    } else {\n        const tags = [\n            `org_id=KIST`,\n            `site_id=site_001`,\n            `chamber_id=${chamberId}`,\n            `type=realtime`\n        ].join(',');\n        \n        const fields = [\n            `current_dli=0.000000`,\n            `data_points=0i`,\n            `progress_percent=${progressPercent}`\n        ].join(',');\n        \n        lines.push(`kocLiveDLI,${tags} ${fields} ${currentTsNs}`);\n    }\n});\n\nmsg.payload = lines.join('\\n');\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 480,
        "wires": [
            [
                "85f3f83c8720728b",
                "1d1673dceccd9927"
            ]
        ]
    },
    {
        "id": "85f3f83c8720728b",
        "type": "http request",
        "z": "7e65b47e49f97f97",
        "name": "Ïã§ÏãúÍ∞Ñ DLI InfluxDB Ï†ÄÏû•",
        "method": "POST",
        "ret": "txt",
        "url": "http://influxdb2:8086/api/v2/write?org=KIST&bucket=KISTopenChamber&precision=ns",
        "headers": [
            {
                "keyType": "Authorization",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "valueType": "other",
                "valueValue": "text/plain; charset=utf-8"
            }
        ],
        "x": 870,
        "y": 480,
        "wires": [
            [
                "5275599803ec4d1e"
            ]
        ]
    },
    {
        "id": "1d1673dceccd9927",
        "type": "debug",
        "z": "7e65b47e49f97f97",
        "name": "Ïã§ÏãúÍ∞Ñ DLI Line Protocol",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "x": 870,
        "y": 440,
        "wires": []
    },
    {
        "id": "5275599803ec4d1e",
        "type": "debug",
        "z": "7e65b47e49f97f97",
        "name": "InfluxDB ÏùëÎãµ",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "x": 1090,
        "y": 480,
        "wires": []
    },
    {
        "id": "56dc413e6e19bea3",
        "type": "inject",
        "z": "7e65b47e49f97f97",
        "name": "DLI ÎàÑÏ†Å ÏÉÅÌÉú ÌôïÏù∏",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "",
        "topic": "",
        "payload": "status",
        "payloadType": "str",
        "x": 390,
        "y": 660,
        "wires": [
            [
                "ffac81211585bd89"
            ]
        ]
    },
    {
        "id": "ffac81211585bd89",
        "type": "function",
        "z": "7e65b47e49f97f97",
        "name": "ÌòÑÏû¨ DLI ÎàÑÏ†Å ÏÉÅÌÉú",
        "func": "// =====================================================\n// 3. \"ÌòÑÏû¨ DLI ÎàÑÏ†Å ÏÉÅÌÉú\" ÎÖ∏Îìú - UTCÎ°ú ÏàòÏ†ï\n// =====================================================\n\nconst dliData = global.get('dli_accumulation') || {};\n\n// UTC Í∏∞Ï§Ä Ïò§Îäò ÎÇ†Ïßú (ÌïúÍµ≠ÏãúÍ∞Ñ Î≥ÄÌôò Ï†úÍ±∞)\nconst now = new Date();\nconst today = now.toISOString().split('T')[0]; // UTC ÎÇ†Ïßú ÏÇ¨Ïö©\n\nnode.log('===== ÌòÑÏû¨ DLI ÎàÑÏ†Å ÏÉÅÌÉú =====');\n\nconst result = [];\nlet todayCount = 0;\n\nfor (const key in dliData) {\n    if (key.endsWith(`_${today}`)) {\n        const data = dliData[key];\n        const currentDLI = (data.accumulated_par / 1000000).toFixed(2);\n        \n        result.push({\n            chamber_id: data.chamber_id,\n            date: today,\n            current_dli: parseFloat(currentDLI),\n            data_points: data.data_points\n        });\n        \n        node.log(`[${data.chamber_id}] ${today} ÌòÑÏû¨ DLI: ${currentDLI} mol/m¬≤/day (${data.data_points}Í∞ú Ï∏°Ï†ï)`);\n        todayCount++;\n    }\n}\n\nif (todayCount === 0) {\n    node.log(`${today} ÎàÑÏ†Å Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå`);\n    node.log(`Ï†ÄÏû•ÏÜå ÌÇ§ Î™©Î°ù: ${Object.keys(dliData).join(', ')}`);\n}\n\nnode.log('==============================');\n\nmsg.payload = result;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 660,
        "wires": [
            [
                "0d8ce43994135bda"
            ]
        ]
    },
    {
        "id": "0d8ce43994135bda",
        "type": "debug",
        "z": "7e65b47e49f97f97",
        "name": "DLI ÏÉÅÌÉú",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "x": 850,
        "y": 660,
        "wires": []
    },
    {
        "id": "6473468f1fb0ce1b",
        "type": "comment",
        "z": "7e65b47e49f97f97",
        "name": "Debug",
        "info": "",
        "x": 210,
        "y": 380,
        "wires": []
    },
    {
        "id": "b41a40fdd4b3a87f",
        "type": "http in",
        "z": "f037c979601d240a",
        "name": "GET /download-csv-new",
        "url": "/download-csv",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 400,
        "y": 200,
        "wires": [
            [
                "1ca03b03e6b1e18f"
            ]
        ]
    },
    {
        "id": "1ca03b03e6b1e18f",
        "type": "function",
        "z": "f037c979601d240a",
        "name": "ÏÉà CSV Ï≤òÎ¶¨Í∏∞",
        "func": "const q = msg.req.query || {};\nconst startDate = q.startDate;\nconst endDate = q.endDate;\nconst chamber = q.chamber_id || 'chamber_001';\nconst fields = q.fields ? q.fields.split(',') : ['pyrRaw', 'tRaw', 'hRaw', 'co2Raw'];\n\nnode.log('CSV Îã§Ïö¥Î°úÎìú: ' + chamber + ', ' + startDate + ' ~ ' + endDate);\nnode.log('ÏöîÏ≤≠Îêú ÌïÑÎìú: ' + fields.join(', '));\n\nif (!startDate || !endDate) {\n  msg.statusCode = 400;\n  msg.payload = { error: 'ÏãúÏûëÏùºÍ≥º Ï¢ÖÎ£åÏùºÏù¥ ÌïÑÏöîÌï©ÎãàÎã§' };\n  return msg;\n}\n\n// ÌïÑÎìú Î∂ÑÎ•ò\nconst sensorFields = fields.filter(f => ['pyrRaw', 'tRaw', 'hRaw', 'co2Raw', 'tBME', 'hBME'].includes(f));\nconst controlFields = fields.filter(f => ['led_actual_status', 'mode', 'onoffValue', 'setPoint', 'avgTime'].includes(f));\nconst dliFields = fields.filter(f => ['current_dli', 'dli'].includes(f));\n\nlet queryParts = [];\n\n// ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ ÏøºÎ¶¨\nif (sensorFields.length > 0) {\n  const sensorFilter = sensorFields.map(f => `r._field == \"${f}\"`).join(' or ');\n  queryParts.push(`sensorData = from(bucket: \"KISTopenChamber\")\n  |> range(start: ${startDate}T00:00:00Z, stop: ${endDate}T23:59:59Z)\n  |> filter(fn: (r) => r._measurement == \"kocData\" and r.chamber_id == \"${chamber}\" and (${sensorFilter}))\n  |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")`);\n}\n\n// Ï†úÏñ¥ Îç∞Ïù¥ÌÑ∞ ÏøºÎ¶¨\nif (controlFields.length > 0) {\n  const controlFilter = controlFields.map(f => `r._field == \"${f}\"`).join(' or ');\n  queryParts.push(`controlData = from(bucket: \"KISTopenChamber\")\n  |> range(start: ${startDate}T00:00:00Z, stop: ${endDate}T23:59:59Z)\n  |> filter(fn: (r) => r._measurement == \"kocControl\" and r.chamber_id == \"${chamber}\" and (${controlFilter}))\n  |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")`);\n}\n\n// Ïã§ÏãúÍ∞Ñ DLI ÏøºÎ¶¨\nif (dliFields.includes('current_dli')) {\n  queryParts.push(`liveDliData = from(bucket: \"KISTopenChamber\")\n  |> range(start: ${startDate}T00:00:00Z, stop: ${endDate}T23:59:59Z)\n  |> filter(fn: (r) => r._measurement == \"kocLiveDLI\" and r.chamber_id == \"${chamber}\" and r._field == \"current_dli\")\n  |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")`);\n}\n\n// ÏùºÏùº DLI ÏøºÎ¶¨\nif (dliFields.includes('dli')) {\n  queryParts.push(`dailyDliData = from(bucket: \"KISTopenChamber\")\n  |> range(start: ${startDate}T00:00:00Z, stop: ${endDate}T23:59:59Z)\n  |> filter(fn: (r) => r._measurement == \"kocDLI\" and r.chamber_id == \"${chamber}\" and r._field == \"dli\")\n  |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")`);\n}\n\nif (queryParts.length === 0) {\n  msg.statusCode = 400;\n  msg.payload = { error: 'Ïú†Ìö®Ìïú ÌïÑÎìúÍ∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§' };\n  return msg;\n}\n\n// ÏøºÎ¶¨ Ï°∞Ìï©\nlet combinedQuery;\nif (queryParts.length === 1) {\n  // Îã®Ïùº Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§ - keep Ï†úÍ±∞\n  combinedQuery = queryParts[0].replace(/^\\w+Data = /, '') + '\\n  |> sort(columns: [\"_time\"])';\n} else {\n  // Ïó¨Îü¨ Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§ Í≤∞Ìï©\n  const tableNames = [];\n  if (sensorFields.length > 0) tableNames.push('sensorData');\n  if (controlFields.length > 0) tableNames.push('controlData');\n  if (dliFields.includes('current_dli')) tableNames.push('liveDliData');\n  if (dliFields.includes('dli')) tableNames.push('dailyDliData');\n\n  combinedQuery = queryParts.join('\\n\\n') + `\\n\\nunion(tables: [${tableNames.join(', ')}])\n  |> group()\n  |> sort(columns: [\"_time\"])`;\n}\n\nnode.log('ÏÉùÏÑ±Îêú ÏøºÎ¶¨:');\nnode.log(combinedQuery);\n\nmsg.payload = combinedQuery;\nmsg.chamber = chamber;\nmsg.startDate = startDate;\nmsg.endDate = endDate;\nmsg.originalFields = fields;\n\nreturn msg;\n\n// const q = msg.req.query || {};\n// const startDate = q.startDate;\n// const endDate = q.endDate;\n// const chamber = q.chamber_id || 'chamber_001';\n// const fields = q.fields ? q.fields.split(',') : ['pyrRaw','tRaw','hRaw','co2Raw'];\n\n// node.log('=== ÏÉà CSV Îã§Ïö¥Î°úÎìú ===');\n// node.log('ÏöîÏ≤≠ ÌïÑÎìú: ' + fields.join(', '));\n\n// if (!startDate || !endDate) {\n//     msg.statusCode = 400;\n//     msg.payload = { error: 'ÏãúÏûëÏùºÍ≥º Ï¢ÖÎ£åÏùºÏù¥ ÌïÑÏöîÌï©ÎãàÎã§' };\n//     return msg;\n// }\n\n// // ÌïòÎÇòÏùò ÌÜµÌï© ÏøºÎ¶¨Î°ú Î™®Îì† Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞\n// const sensorFields = fields.filter(f => ['pyrRaw', 'tRaw', 'hRaw', 'co2Raw'].includes(f));\n// const controlFields = fields.filter(f => ['led_actual_status', 'mode', 'onoffValue', 'setPoint'].includes(f));\n// const hasDli = fields.includes('current_dli') || fields.includes('dli');\n\n// let combinedQuery = '';\n// let queryParts = [];\n\n// // ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ ÏøºÎ¶¨\n// if (sensorFields.length > 0) {\n//     const sensorFilter = sensorFields.map(f => `r._field == \"${f}\"`).join(' or ');\n//     queryParts.push(`\n// // ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞\n// sensorData = from(bucket: \"KISTopenChamber\")\n//   |> range(start: ${startDate}T00:00:00Z, stop: ${endDate}T23:59:59Z)\n//   |> filter(fn: (r) => r._measurement == \"kocData\" and r.chamber_id == \"${chamber}\" and (${sensorFilter}))\n//   |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n//   |> map(fn: (r) => ({_time: r._time, pyrRaw: r.pyrRaw, tRaw: r.tRaw, hRaw: r.hRaw, co2Raw: r.co2Raw}))`);\n// }\n\n// // Ï†úÏñ¥ Îç∞Ïù¥ÌÑ∞ ÏøºÎ¶¨\n// if (controlFields.length > 0) {\n//     const controlFilter = controlFields.map(f => `r._field == \"${f}\"`).join(' or ');\n//     queryParts.push(`\n// // Ï†úÏñ¥ Îç∞Ïù¥ÌÑ∞\n// controlData = from(bucket: \"KISTopenChamber\")\n//   |> range(start: ${startDate}T00:00:00Z, stop: ${endDate}T23:59:59Z)\n//   |> filter(fn: (r) => r._measurement == \"kocControl\" and r.chamber_id == \"${chamber}\" and (${controlFilter}))\n//   |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n//   |> map(fn: (r) => ({_time: r._time, led_actual_status: r.led_actual_status, mode: r.mode, onoffValue: r.onoffValue, setPoint: r.setPoint}))`);\n// }\n\n// // ÌÜµÌï© ÏøºÎ¶¨ ÏÉùÏÑ±\n// if (sensorFields.length > 0 && controlFields.length > 0) {\n//     combinedQuery = queryParts.join('\\n') + `\n\n// // Îç∞Ïù¥ÌÑ∞ Í≤∞Ìï©\n// union(tables: [sensorData, controlData])\n//   |> group()\n//   |> sort(columns: [\"_time\"])`;\n// } else if (sensorFields.length > 0) {\n//     combinedQuery = queryParts[0].replace('sensorData = ', '') + '\\n  |> group()\\n  |> sort(columns: [\"_time\"])';\n// } else if (controlFields.length > 0) {\n//     combinedQuery = queryParts[0].replace('controlData = ', '') + '\\n  |> group()\\n  |> sort(columns: [\"_time\"])';\n// }\n\n// node.log('ÏÉùÏÑ±Îêú ÏøºÎ¶¨:');\n// node.log(combinedQuery);\n\n// msg.payload = combinedQuery;\n// msg.chamber = chamber;\n// msg.startDate = startDate;\n// msg.endDate = endDate;\n// msg.originalFields = fields;\n\n// return msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 200,
        "wires": [
            [
                "9a7adc3a6e6e5d32",
                "726cc22e30451b2d"
            ]
        ]
    },
    {
        "id": "9a7adc3a6e6e5d32",
        "type": "http request",
        "z": "f037c979601d240a",
        "name": "ÏÉà InfluxDB ÏöîÏ≤≠",
        "method": "POST",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "http://influxdb2:8086/api/v2/query?org=KIST",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "Token Bb-szpfIgXjnHyMy3_0W2-rCnawwbyDydUsKYydCq_7WEvw58eom_-cPUUyacrCRhr3p-Wk9WKM4PI7vqYQV9Q=="
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/vnd.flux"
            },
            {
                "keyType": "Accept",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/csv"
            }
        ],
        "x": 870,
        "y": 200,
        "wires": [
            [
                "a1d6208d4f3eaf59"
            ]
        ]
    },
    {
        "id": "a1d6208d4f3eaf59",
        "type": "function",
        "z": "f037c979601d240a",
        "name": "ÏÉà CSV Î≥ÄÌôòÍ∏∞",
        "func": "\nconst fieldNameMap = {\n    // ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞\n    'pyrRaw': 'ÏùºÏÇ¨Îüâ_Wm2',\n    'tRaw': 'Ïò®ÎèÑ_C',\n    'hRaw': 'ÏäµÎèÑ_percent',\n    'co2Raw': 'CO2_ppm',\n    'tBME': 'Ïò®ÎèÑBME_C',\n    'hBME': 'ÏäµÎèÑBME_percent',\n\n    // Ï†úÏñ¥ Îç∞Ïù¥ÌÑ∞\n    'led_actual_status': 'LEDÏã§Ï†úÏÉÅÌÉú',\n    'mode': 'Ï†úÏñ¥Î™®Îìú',\n    'onoffValue': 'ON_OFFÍ∞í',\n    'setPoint': 'ÏÑ§Ï†ïÍ∞í',\n    'avgTime': 'ÌèâÍ∑†ÏãúÍ∞Ñ_Î∂Ñ',\n\n    // DLI Îç∞Ïù¥ÌÑ∞\n    'current_dli': 'Ïã§ÏãúÍ∞ÑDLI_mol_m2_day',\n    'dli': 'ÏùºÏùºDLI_mol_m2_day',\n\n    // Í≥µÌÜµ\n    '_time': 'ÏãúÍ∞Ñ'\n};\n\nconst csvText = msg.payload || '';\n\nnode.log('Î∞õÏùÄ CSV Í∏∏Ïù¥: ' + csvText.length);\n\nif (!csvText || csvText.length < 10) {\n    msg.statusCode = 404;\n    msg.payload = { error: 'Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§' };\n    return msg;\n}\n\n// CSV ÌååÏã± - InfluxDB Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ ÎùºÏù∏ Ï†úÍ±∞\nconst lines = csvText.split(/\\r?\\n/).filter(line => {\n    const trimmed = line.trim();\n    return trimmed &&\n        !trimmed.startsWith('#') &&\n        !trimmed.startsWith('//');\n});\n\nif (lines.length < 2) {\n    msg.statusCode = 404;\n    msg.payload = { error: 'Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§' };\n    return msg;\n}\n\nconst headers = lines[0].split(',').map(h => h.trim().replace(/\"/g, ''));\nnode.log('ÏõêÎ≥∏ Ìó§Îçî: ' + headers.join(', '));\n\n// Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ïª¨Îüº Ï†úÏô∏\nconst excludeColumns = ['result', 'table', '_start', '_stop', '_measurement',\n    'chamber_id', 'collector_id', 'fw_version', 'org_id', 'site_id'];\nconst filteredHeaders = headers.filter(h => !excludeColumns.includes(h));\nconst mappedHeaders = filteredHeaders.map(h => fieldNameMap[h] || h);\n\nnode.log('ÌïúÍ∏Ä Ìó§Îçî: ' + mappedHeaders.join(', '));\n\n// CSV Ïû¨Íµ¨ÏÑ±\nconst newLines = [mappedHeaders.join(',')];\n\nfor (let i = 1; i < lines.length; i++) {\n    const values = lines[i].split(',').map(v => v.trim().replace(/\"/g, ''));\n\n    const filteredValues = [];\n    filteredHeaders.forEach(header => {\n        const index = headers.indexOf(header);\n        filteredValues.push(index >= 0 ? (values[index] || '') : '');\n    });\n\n    newLines.push(filteredValues.join(','));\n}\n\nconst finalCSV = newLines.join('\\n');\n\nnode.log('ÏµúÏ¢Ö CSV: ' + newLines.length + 'Ï§Ñ, ' + filteredHeaders.length + 'Ïó¥');\n\nmsg.payload = finalCSV;\nmsg.headers = {\n    'Content-Type': 'text/csv; charset=utf-8',\n    'Content-Disposition': 'attachment; filename=\"KIST_' + msg.chamber + '_' + msg.startDate + '_' + msg.endDate + '.csv\"',\n    'Access-Control-Allow-Origin': '*',\n    'Cache-Control': 'no-cache'\n};\nmsg.statusCode = 200;\n\nreturn msg;\n\n\n// const fieldNameMap = {\n//     'pyrRaw': 'ÏùºÏÇ¨Îüâ_Wm2',\n//     'tRaw': 'Ïò®ÎèÑ_C',\n//     'hRaw': 'ÏäµÎèÑ_percent',\n//     'co2Raw': 'CO2_ppm',\n//     'led_actual_status': 'LEDÏã§Ï†úÏÉÅÌÉú',\n//     'mode': 'Ï†úÏñ¥Î™®Îìú',\n//     'onoffValue': 'ON_OFFÍ∞í',\n//     'setPoint': 'ÏÑ§Ï†ïÍ∞í',\n//     '_time': 'ÏãúÍ∞Ñ'\n// };\n\n// const csvText = msg.payload || '';\n\n// node.log('Î∞õÏùÄ CSV Í∏∏Ïù¥: ' + csvText.length);\n// node.log('Ï≤´ 500Ïûê: ' + csvText.substring(0, 500));\n\n// if (!csvText || csvText.length < 10) {\n//     msg.statusCode = 404;\n//     msg.payload = { error: 'Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§' };\n//     return msg;\n// }\n\n// // CSV ÌååÏã±\n// const lines = csvText.split(/\\r?\\n/).filter(line => {\n//     const trimmed = line.trim();\n//     return trimmed && \n//            !trimmed.startsWith('#') && \n//            !trimmed.startsWith('//');\n// });\n\n// if (lines.length < 2) {\n//     msg.statusCode = 404;\n//     msg.payload = { error: 'Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§' };\n//     return msg;\n// }\n\n// const headers = lines[0].split(',').map(h => h.trim().replace(/\"/g, ''));\n// node.log('ÏõêÎ≥∏ Ìó§Îçî: ' + headers.join(', '));\n\n// // Ìó§Îçî ÌïúÍ∏ÄÌôî (Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ïª¨Îüº Ï†úÏô∏)\n// const excludeColumns = ['result', 'table', '_start', '_stop', '_measurement', 'chamber_id', 'collector_id', 'fw_version', 'org_id', 'site_id'];\n// const filteredHeaders = headers.filter(h => !excludeColumns.includes(h));\n// const mappedHeaders = filteredHeaders.map(h => fieldNameMap[h] || h);\n\n// node.log('ÌïÑÌÑ∞Îêú Ìó§Îçî: ' + filteredHeaders.join(', '));\n// node.log('ÌïúÍ∏Ä Ìó§Îçî: ' + mappedHeaders.join(', '));\n\n// // CSV Ïû¨Íµ¨ÏÑ±\n// const newLines = [mappedHeaders.join(',')];\n\n// for (let i = 1; i < lines.length; i++) {\n//     const values = lines[i].split(',').map(v => v.trim().replace(/\"/g, ''));\n    \n//     // ÌïÑÌÑ∞Îêú Ìó§ÎçîÏóê Ìï¥ÎãπÌïòÎäî Í∞íÎì§Îßå Ï∂îÏ∂ú\n//     const filteredValues = [];\n//     filteredHeaders.forEach(header => {\n//         const index = headers.indexOf(header);\n//         filteredValues.push(index >= 0 ? (values[index] || '') : '');\n//     });\n    \n//     newLines.push(filteredValues.join(','));\n// }\n\n// const finalCSV = newLines.join('\\n');\n\n// node.log('ÏµúÏ¢Ö CSV ÏÉùÏÑ±: ' + newLines.length + 'Ï§Ñ');\n// node.log('Ï≤´ 3Ï§Ñ:');\n// for (let i = 0; i < Math.min(3, newLines.length); i++) {\n//     node.log('  ' + newLines[i]);\n// }\n\n// msg.payload = finalCSV;\n// msg.headers = {\n//     'Content-Type': 'text/csv; charset=utf-8',\n//     'Content-Disposition': 'attachment; filename=\"KIST_' + msg.chamber + '_' + msg.startDate + '_' + msg.endDate + '.csv\"',\n//     'Access-Control-Allow-Origin': '*',\n//     'Cache-Control': 'no-cache'\n// };\n// msg.statusCode = 200;\n\n// return msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1100,
        "y": 200,
        "wires": [
            [
                "9a181a64db21ff0f",
                "f7413e0ad15af055"
            ]
        ]
    },
    {
        "id": "9a181a64db21ff0f",
        "type": "http response",
        "z": "f037c979601d240a",
        "name": "ÏÉà CSV ÏùëÎãµ",
        "statusCode": "",
        "headers": {},
        "x": 1310,
        "y": 200,
        "wires": []
    },
    {
        "id": "726cc22e30451b2d",
        "type": "debug",
        "z": "f037c979601d240a",
        "name": "debug 11",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 800,
        "y": 140,
        "wires": []
    },
    {
        "id": "f7413e0ad15af055",
        "type": "debug",
        "z": "f037c979601d240a",
        "name": "debug 12",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1260,
        "y": 140,
        "wires": []
    }
]